<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é¢˜åˆ†æå™¨ - æµ·åº•ææ™ºèƒ½æ•°æ®å¤„ç†å¹³å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”¥</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .nav-brand .logo {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-link {
            text-decoration: none;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .nav-link:hover {
            background: #007bff;
            color: white;
        }
        
        .nav-link.active {
            background: #007bff;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #0056b3;
            background: #f8f9ff;
        }
        
        .upload-section.dragover {
            border-color: #28a745;
            background: #f8fff8;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .category-list {
            margin-top: 20px;
        }
        
        .category-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .category-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
        }
        
        .category-count {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .category-keywords {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .category-examples {
            font-size: 13px;
            color: #495057;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <span class="logo">ğŸ”¥</span>
                æµ·åº•ææ™ºèƒ½æ•°æ®å¤„ç†å¹³å°
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a>
                <a href="index.html" class="nav-link">ğŸ“Š æ•°æ®å¤„ç†</a>
                <a href="department.html" class="nav-link">ğŸ¢ éƒ¨é—¨åˆ†ç±»</a>
                <a href="question-analyzer.html" class="nav-link active">ğŸ” é—®é¢˜åˆ†æ</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ğŸ” é—®é¢˜åˆ†æå™¨</h1>
            <p class="subtitle">æ™ºèƒ½é—®é¢˜åˆ†ç±»ä¸çƒ­ç‚¹åˆ†æâ€”â€”åŸºäºTF-IDFç®—æ³•çš„æ–‡æœ¬æŒ–æ˜</p>
        </div>
        
        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="upload">ğŸ“ æ•°æ®ä¸Šä¼ </button>
                <button class="nav-tab" data-tab="config">âš™ï¸ é…ç½®è®¾ç½®</button>
                <button class="nav-tab" data-tab="analysis">ğŸ“Š åˆ†æç»“æœ</button>
                <button class="nav-tab" data-tab="export">ğŸ’¾ å¯¼å‡ºä¸‹è½½</button>
            </div>
            
            <!-- æ•°æ®ä¸Šä¼ æ ‡ç­¾é¡µ -->
            <div id="upload-tab" class="tab-content active">
                <div class="upload-section" id="upload-area">
                    <div>
                        <h3>ğŸ“‚ ä¸Šä¼ Excelæˆ–CSVæ–‡ä»¶</h3>
                        <p style="margin: 15px 0; color: #6c757d;">
                            æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼ï¼Œæ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸæˆ–ç‚¹å‡»æŒ‰é’®é€‰æ‹©
                        </p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv" />
                        <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                            é€‰æ‹©æ–‡ä»¶
                        </button>
                        <div id="file-info" style="margin-top: 15px; color: #495057;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é—®é¢˜åˆ—åç§°</label>
                    <input type="text" id="question-column" class="form-control" value="é—®é¢˜" placeholder="è¾“å…¥åŒ…å«é—®é¢˜çš„åˆ—å">
                    <small style="color: #6c757d;">è¯·ç¡®ä¿åˆ—åä¸Excelæ–‡ä»¶ä¸­çš„æ ‡é¢˜å®Œå…¨ä¸€è‡´</small>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">èšç±»æ•°é‡</label>
                        <input type="number" id="n-clusters" class="form-control" value="12" min="5" max="20">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">å…³é”®è¯æ•°é‡</label>
                        <input type="number" id="top-keywords" class="form-control" value="25" min="10" max="50">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startAnalysis()" style="width: 100%; padding: 15px; font-size: 16px;">
                    ğŸš€ å¼€å§‹åˆ†æ
                </button>
            </div>
            
            <!-- é…ç½®è®¾ç½®æ ‡ç­¾é¡µ -->
            <div id="config-tab" class="tab-content">
                <div class="config-section">
                    <h3>ğŸ¯ è‡ªå®šä¹‰ç±»åˆ«é…ç½®</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">
                        é€šè¿‡å…³é”®è¯å®šä¹‰é—®é¢˜åˆ†ç±»ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å°†åŒ…å«è¿™äº›å…³é”®è¯çš„é—®é¢˜å½’ç±»åˆ°å¯¹åº”ç±»åˆ«
                    </p>
                    
                    <div id="custom-categories">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„ç±»åˆ«é…ç½® -->
                    </div>
                    
                    <button class="btn btn-success" onclick="addCustomCategory()">+ æ·»åŠ æ–°ç±»åˆ«</button>
                </div>
                
                <div class="config-section">
                    <h3>ğŸš« åœç”¨è¯é…ç½®</h3>
                    <label class="form-label">å¿½ç•¥çš„å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <textarea id="ignore-keywords" class="form-control" rows="3" 
                              placeholder="é—®é¢˜,ä»€ä¹ˆ,æ€ä¹ˆ,å¦‚ä½•,è¯·é—®,å’¨è¯¢,äº†è§£,çŸ¥é“">é—®é¢˜,ä»€ä¹ˆ,æ€ä¹ˆ,å¦‚ä½•,è¯·é—®,å’¨è¯¢,äº†è§£,çŸ¥é“,å¯ä»¥,èƒ½å¦,æ˜¯å¦,èƒ½ä¸èƒ½,å¯ä¸å¯ä»¥,æœ‰æ²¡æœ‰,å¤šå°‘,å“ªé‡Œ</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="btn btn-success" onclick="loadHaidilaoConfig()">ğŸ”¥ åŠ è½½æµ·åº•æé¢„è®¾</button>
            </div>
            
            <!-- åˆ†æç»“æœæ ‡ç­¾é¡µ -->
            <div id="analysis-tab" class="tab-content">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div id="results-container" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-questions">0</div>
                            <div class="stat-label">æ€»é—®é¢˜æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-categories">0</div>
                            <div class="stat-label">è¯†åˆ«ç±»åˆ«</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="custom-categories-count">0</div>
                            <div class="stat-label">è‡ªå®šä¹‰ç±»åˆ«</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="top-keywords-count">0</div>
                            <div class="stat-label">å…³é”®è¯</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">ğŸ“Š é—®é¢˜åˆ†ç±»åˆ†å¸ƒ</div>
                        <canvas id="category-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">ğŸ” å…³é”®è¯é‡è¦åº¦</div>
                        <canvas id="keywords-chart"></canvas>
                    </div>
                    
                    <div class="category-list" id="category-list">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†ç±»åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
            
            <!-- å¯¼å‡ºä¸‹è½½æ ‡ç­¾é¡µ -->
            <div id="export-tab" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3>ğŸ’¾ å¯¼å‡ºåˆ†æç»“æœ</h3>
                    <p style="margin: 20px 0; color: #6c757d;">
                        å°†åˆ†æç»“æœå¯¼å‡ºä¸ºExcelæ–‡ä»¶ï¼ŒåŒ…å«åŸæ•°æ®åˆ†ç±»ã€ç»Ÿè®¡æ±‡æ€»ã€è¯¦ç»†åˆ†æç­‰å¤šä¸ªå·¥ä½œè¡¨
                    </p>
                    
                    <div style="margin: 30px 0;">
                        <button class="btn btn-success" onclick="exportResults()" style="padding: 15px 30px; font-size: 16px;">
                            ğŸ“¥ ä¸‹è½½å®Œæ•´åˆ†æç»“æœ
                        </button>
                    </div>
                    
                    <div id="export-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="export-progress-fill"></div>
                        </div>
                        <p id="export-status">æ­£åœ¨å‡†å¤‡å¯¼å‡º...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileData = null;
        let analysisResults = null;
        let config = {
            custom_keywords: {},
            ignore_keywords: new Set(['é—®é¢˜', 'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'å¦‚ä½•', 'è¯·é—®', 'å’¨è¯¢', 'äº†è§£', 'çŸ¥é“'])
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            initializeTabs();
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
            initializeFileUpload();
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        function initializeTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabName);
            
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            const allBtns = document.querySelectorAll('.nav-tab');
            allBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šæ ‡ç­¾é¡µ
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // æ·»åŠ å¯¹åº”æŒ‰é’®çš„activeç±»
            const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function initializeFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            console.log('å¤„ç†æ–‡ä»¶:', file.name);
            const fileInfo = document.getElementById('file-info');
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            fileInfo.innerHTML = `
                <div class="success">
                    âœ… æ–‡ä»¶å·²é€‰æ‹©ï¼š${fileName} (${fileSize} MB)
                </div>
            `;
            
            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (fileName.endsWith('.csv')) {
                        // å¤„ç†CSVæ–‡ä»¶
                        const csvData = e.target.result;
                        const parsed = Papa.parse(csvData, {
                            header: true,
                            skipEmptyLines: true,
                            encoding: 'UTF-8'
                        });
                        fileData = parsed.data;
                    } else {
                        // å¤„ç†Excelæ–‡ä»¶
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        fileData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    fileInfo.innerHTML += `
                        <div class="success">
                            ğŸ“Š æ•°æ®è§£ææˆåŠŸï¼šå…± ${fileData.length} è¡Œæ•°æ®
                        </div>
                    `;
                    
                    // æ£€æµ‹åˆ—å
                    if (fileData.length > 0) {
                        const columns = Object.keys(fileData[0]);
                        console.log('æ£€æµ‹åˆ°çš„åˆ—åï¼š', columns);
                        
                        // æ™ºèƒ½æ£€æµ‹é—®é¢˜åˆ—
                        const questionColumns = columns.filter(col => 
                            col.includes('é—®é¢˜') || col.includes('å†…å®¹') || col.includes('é—®')
                        );
                        
                        if (questionColumns.length > 0) {
                            document.getElementById('question-column').value = questionColumns[0];
                        }
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                    fileInfo.innerHTML = `
                        <div class="error">
                            âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${error.message}
                        </div>
                    `;
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰ç±»åˆ«
        function addCustomCategory() {
            const container = document.getElementById('custom-categories');
            const categoryId = 'category_' + Date.now();
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'form-group';
            categoryDiv.innerHTML = `
                <label class="form-label">ç±»åˆ«åç§°</label>
                <input type="text" class="form-control category-name" placeholder="ä¾‹å¦‚ï¼šå‘˜å·¥å²—ä½ç±»">
                <label class="form-label" style="margin-top: 10px;">å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                <input type="text" class="form-control category-keywords" placeholder="ä¾‹å¦‚ï¼šå²—ä½æµç¨‹,è®¤è¯,å—¨å­¦å ‚,å˜è„¸">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤æ­¤ç±»åˆ«</button>
            `;
            
            container.appendChild(categoryDiv);
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const customCategories = {};
            const categoryDivs = document.querySelectorAll('#custom-categories .form-group');
            
            categoryDivs.forEach(div => {
                const nameInput = div.querySelector('.category-name');
                const keywordsInput = div.querySelector('.category-keywords');
                
                if (nameInput && keywordsInput && nameInput.value && keywordsInput.value) {
                    const keywords = keywordsInput.value.split(',').map(k => k.trim()).filter(k => k);
                    customCategories[nameInput.value] = keywords;
                }
            });
            
            config.custom_keywords = customCategories;
            
            const ignoreKeywords = document.getElementById('ignore-keywords').value
                .split(',').map(k => k.trim()).filter(k => k);
            config.ignore_keywords = new Set(ignoreKeywords);
            
            console.log('é…ç½®å·²ä¿å­˜:', config);
            alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
        }

        // åŠ è½½æµ·åº•æé¢„è®¾é…ç½®
        function loadHaidilaoConfig() {
            const haidilaoConfig = {
                "å‘˜å·¥å²—ä½ç±»": ["è€ƒè¯ä¹¦","æ‹…å½“è¯ä¹¦","å²—ä½æµç¨‹", "å¤§å ‚ç»ç†å²—ä½æµç¨‹", "å¤§å ‚ç»ç†æµç¨‹", "åå ‚ç»ç†å²—ä½æµç¨‹", "åå ‚ç»ç†æµç¨‹","å²—ä½æ ‡å‡†","å²—ä½è¯ä¹¦","å²—ä½è®¤è¯","è®¤è¯","å—¨å­¦å ‚","å˜è„¸","åº“ç®¡","å¿ƒè‚ºå¤è‹"],
                "æœåŠ¡æŠ€å·§æå‡ç±»": ["å‘˜å·¥", "åŸ¹è®­", "å­¦ä¹ ", "è€ƒæ ¸", "ç»©æ•ˆ", "æ™‹å‡", "å‡èŒ", "èŒä¸šå‘å±•"],
                "æµç¨‹ç›¸å…³é—®é¢˜": ["æµç¨‹", "è§„å®š", "æ”¿ç­–", "æ ‡å‡†", "è¦æ±‚", "æ“ä½œ", "åˆ¶åº¦"],
                "å²—ä½ç›¸å…³é—®é¢˜": ["å²—ä½", "èŒè´£", "å·¥ä½œ", "ä»»åŠ¡", "åˆ†å·¥", "èŒä½"],
                "æµ·åº•ææœåŠ¡": ["æµ·åº•æ", "ç‰¹è‰²", "æ–‡åŒ–", "ç†å¿µ", "å“ç‰Œ"],
                "é—¨åº—è¿è¥ç®¡ç†": ["é—¨åº—", "åº—é¢", "è¥ä¸š", "å¼€åº—", "å…³åº—", "è¥ä¸šæ—¶é—´", "åº—é•¿", "åº—ç»ç†"],
                "é£Ÿå“å®‰å…¨ç®¡ç†": ["é£Ÿå“", "å®‰å…¨", "å«ç”Ÿ", "æ¸…æ´", "æ¶ˆæ¯’", "é£Ÿæ", "è¿‡æœŸ", "æ–°é²œ"],
                "æ’ç­è°ƒåº¦ç®¡ç†": ["æ’ç­", "è°ƒç­", "æ¢ç­", "è¯·å‡", "ä¼‘å‡", "æ—¶é—´", "ç­æ¬¡"],
                "è–ªé…¬ç¦åˆ©ç®¡ç†": ["å·¥èµ„", "è–ªæ°´", "è–ªèµ„", "å¥–é‡‘", "è¡¥è´´", "ç¦åˆ©", "ä¿é™©"],
                "æŠ¥é”€è´¹ç”¨ç®¡ç†": ["æŠ¥é”€", "å‘ç¥¨", "è´¹ç”¨", "å·®æ—…", "äº¤é€š", "ä½å®¿", "é¤è´¹"],
                "è®¾å¤‡ç»´æŠ¤ç®¡ç†": ["è®¾å¤‡", "ç»´ä¿®", "æ•…éšœ", "ä¿å…»", "ç»´æŠ¤", "æœºå™¨", "å·¥å…·"],
                "ä¿¡æ¯ç³»ç»Ÿç®¡ç†": ["ç³»ç»Ÿ", "è½¯ä»¶", "ç”µè„‘", "ç½‘ç»œ", "ç™»å½•", "å¯†ç ", "ç¨‹åº"],
                "åº“å­˜ç‰©æ–™ç®¡ç†": ["åº“å­˜", "ç‰©æ–™", "é‡‡è´­", "é…é€", "ä¾›åº”", "å…¥åº“", "å‡ºåº“"]
            };
            
            // æ¸…ç©ºç°æœ‰é…ç½®
            document.getElementById('custom-categories').innerHTML = '';
            
            // æ·»åŠ é¢„è®¾é…ç½®
            Object.entries(haidilaoConfig).forEach(([category, keywords]) => {
                addCustomCategory();
                const lastCategory = document.querySelector('#custom-categories .form-group:last-child');
                if (lastCategory) {
                    const nameInput = lastCategory.querySelector('.category-name');
                    const keywordsInput = lastCategory.querySelector('.category-keywords');
                    if (nameInput) nameInput.value = category;
                    if (keywordsInput) keywordsInput.value = keywords.join(', ');
                }
            });
            
            alert('âœ… æµ·åº•æé¢„è®¾é…ç½®å·²åŠ è½½ï¼');
        }

        // å¼€å§‹åˆ†æ
        function startAnalysis() {
            if (!fileData) {
                alert('âŒ è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }
            
            // ä¿å­˜å½“å‰é…ç½®
            saveConfig();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            
            // åˆ‡æ¢åˆ°åˆ†æç»“æœæ ‡ç­¾é¡µ
            switchTab('analysis');
            
            // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
            setTimeout(() => {
                performAnalysis();
            }, 1000);
        }

        // æ‰§è¡Œåˆ†æ
        function performAnalysis() {
            try {
                const questionColumn = document.getElementById('question-column').value;
                const nClusters = parseInt(document.getElementById('n-clusters').value);
                const topKeywords = parseInt(document.getElementById('top-keywords').value);
                
                // æ£€æŸ¥é—®é¢˜åˆ—æ˜¯å¦å­˜åœ¨
                if (!fileData[0] || !fileData[0][questionColumn]) {
                    throw new Error(`æ‰¾ä¸åˆ°åˆ—åï¼š${questionColumn}`);
                }
                
                // æå–é—®é¢˜æ•°æ®
                const questions = fileData.map(row => row[questionColumn]).filter(q => q && q.trim());
                
                console.log('å¼€å§‹åˆ†æ', questions.length, 'ä¸ªé—®é¢˜');
                
                // å¢å¼ºç‰ˆåˆ†æé€»è¾‘
                const analysisResult = enhancedQuestionAnalysis(questions, config, nClusters);
                
                // ä¿å­˜ç»“æœ
                analysisResults = analysisResult;
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(analysisResult);
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
                
            } catch (error) {
                console.error('åˆ†æé”™è¯¯ï¼š', error);
                document.getElementById('loading').style.display = 'none';
                alert('âŒ åˆ†æå¤±è´¥ï¼š' + error.message);
            }
        }

        // å¢å¼ºç‰ˆé—®é¢˜åˆ†æå‡½æ•°
        function enhancedQuestionAnalysis(questions, config, nClusters) {
            console.log('æ‰§è¡Œå¢å¼ºç‰ˆé—®é¢˜åˆ†æ...');
            
            // æ”¹è¿›çš„ä¸­æ–‡æ–‡æœ¬å¤„ç†
            function preprocessText(text) {
                if (!text) return '';
                // æ¸…ç†HTMLæ ‡ç­¾å’Œç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™ä¸­æ–‡å’ŒåŸºæœ¬æ ‡ç‚¹
                return text.toString()
                    .replace(/<[^>]*>/g, '')
                    .replace(/[^\u4e00-\u9fa5a-zA-Z0-9ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘]/g, ' ')
                    .toLowerCase()
                    .trim();
            }
            
            // æ”¹è¿›çš„ä¸­æ–‡åˆ†è¯
            function segmentChinese(text) {
                const stopWords = config.ignore_keywords || new Set();
                const words = [];
                
                // åŸºäºå­—ç¬¦ç±»å‹çš„ç®€å•åˆ†è¯
                let currentWord = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    
                    if (/[\u4e00-\u9fa5]/.test(char)) {
                        // ä¸­æ–‡å­—ç¬¦
                        currentWord += char;
                        // æ£€æŸ¥æ˜¯å¦å½¢æˆå¸¸è§è¯æ±‡
                        if (currentWord.length >= 2) {
                            if (!stopWords.has(currentWord) && currentWord.length <= 6) {
                                words.push(currentWord);
                            }
                            // ä¿æŒæ»‘åŠ¨çª—å£
                            if (currentWord.length > 3) {
                                currentWord = currentWord.slice(-2);
                            }
                        }
                    } else if (/[a-zA-Z0-9]/.test(char)) {
                        // è‹±æ–‡æ•°å­—
                        currentWord += char;
                    } else {
                        // åˆ†éš”ç¬¦
                        if (currentWord.length > 1 && !stopWords.has(currentWord)) {
                            words.push(currentWord);
                        }
                        currentWord = '';
                    }
                }
                
                // å¤„ç†æœ€åçš„è¯
                if (currentWord.length > 1 && !stopWords.has(currentWord)) {
                    words.push(currentWord);
                }
                
                return words;
            }
            
            // TF-IDFé£æ ¼çš„å…³é”®è¯æå–
            function extractKeywords(questions) {
                const wordFreq = {};
                const docFreq = {};
                const totalDocs = questions.length;
                
                // è®¡ç®—è¯é¢‘å’Œæ–‡æ¡£é¢‘ç‡
                questions.forEach(question => {
                    const text = preprocessText(question);
                    const words = segmentChinese(text);
                    const uniqueWords = new Set(words);
                    
                    words.forEach(word => {
                        wordFreq[word] = (wordFreq[word] || 0) + 1;
                    });
                    
                    uniqueWords.forEach(word => {
                        docFreq[word] = (docFreq[word] || 0) + 1;
                    });
                });
                
                // è®¡ç®—TF-IDFåˆ†æ•°
                const tfidfScores = {};
                Object.keys(wordFreq).forEach(word => {
                    const tf = wordFreq[word];
                    const df = docFreq[word];
                    const idf = Math.log(totalDocs / (df + 1));
                    tfidfScores[word] = tf * idf;
                });
                
                return Object.entries(tfidfScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 25)
                    .map(([word, score]) => ({ word, score: score.toFixed(3) }));
            }
            
            // æ”¹è¿›çš„é—®é¢˜åˆ†ç±»
            function categorizeQuestions(questions, config) {
                const categories = {};
                const uncategorized = [];
                
                questions.forEach((question, index) => {
                    let assigned = false;
                    let bestMatch = null;
                    let maxScore = 0;
                    
                    const questionText = preprocessText(question);
                    const questionWords = new Set(segmentChinese(questionText));
                    
                    // è‡ªå®šä¹‰ç±»åˆ«åŒ¹é…ï¼ˆåŸºäºå…³é”®è¯è¦†ç›–ç‡ï¼‰
                    if (config.custom_keywords) {
                        for (const [categoryName, keywords] of Object.entries(config.custom_keywords)) {
                            let matchScore = 0;
                            let matchCount = 0;
                            
                            keywords.forEach(keyword => {
                                const keywordLower = keyword.toLowerCase();
                                if (questionText.includes(keywordLower)) {
                                    matchCount++;
                                    matchScore += keyword.length; // é•¿å…³é”®è¯æƒé‡æ›´é«˜
                                }
                            });
                            
                            if (matchCount > 0) {
                                const score = matchScore + (matchCount * 2);
                                if (score > maxScore) {
                                    maxScore = score;
                                    bestMatch = categoryName;
                                }
                            }
                        }
                    }
                    
                    if (bestMatch) {
                        if (!categories[bestMatch]) {
                            categories[bestMatch] = [];
                        }
                        categories[bestMatch].push(question);
                        assigned = true;
                    }
                    
                    if (!assigned) {
                        uncategorized.push(question);
                    }
                });
                
                // å¯¹æœªåˆ†ç±»é—®é¢˜è¿›è¡Œè‡ªåŠ¨èšç±»
                if (uncategorized.length > 0) {
                    const autoClusters = autoClusterQuestions(uncategorized, Math.min(5, Math.floor(uncategorized.length / 10)));
                    Object.assign(categories, autoClusters);
                }
                
                return categories;
            }
            
            // è‡ªåŠ¨èšç±»æœªåˆ†ç±»é—®é¢˜
            function autoClusterQuestions(questions, maxClusters) {
                if (questions.length === 0) return {};
                
                const clusters = {};
                const wordFreq = {};
                
                // ç»Ÿè®¡æœªåˆ†ç±»é—®é¢˜ä¸­çš„é«˜é¢‘è¯
                questions.forEach(question => {
                    const words = segmentChinese(preprocessText(question));
                    words.forEach(word => {
                        if (word.length >= 2) {
                            wordFreq[word] = (wordFreq[word] || 0) + 1;
                        }
                    });
                });
                
                // æ‰¾å‡ºé«˜é¢‘å…³é”®è¯ä½œä¸ºèšç±»ä¸­å¿ƒ
                const topWords = Object.entries(wordFreq)
                    .filter(([word, freq]) => freq >= 2)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, maxClusters)
                    .map(([word, freq]) => word);
                
                // åŸºäºå…³é”®è¯è¿›è¡Œèšç±»
                const assigned = new Set();
                topWords.forEach(centerWord => {
                    const clusterQuestions = [];
                    
                    questions.forEach((question, index) => {
                        if (assigned.has(index)) return;
                        
                        const questionText = preprocessText(question);
                        if (questionText.includes(centerWord)) {
                            clusterQuestions.push(question);
                            assigned.add(index);
                        }
                    });
                    
                    if (clusterQuestions.length > 0) {
                        clusters[`${centerWord}ç›¸å…³é—®é¢˜`] = clusterQuestions;
                    }
                });
                
                // å‰©ä½™æœªåˆ†ç±»çš„å½’ä¸º"å…¶ä»–é—®é¢˜"
                const remaining = questions.filter((q, index) => !assigned.has(index));
                if (remaining.length > 0) {
                    clusters['å…¶ä»–é—®é¢˜'] = remaining;
                }
                
                return clusters;
            }
            
            const keywords = extractKeywords(questions);
            const categories = categorizeQuestions(questions, config);
            
            // è½¬æ¢ä¸ºåˆ†æç»“æœæ ¼å¼ï¼Œå¹¶ä¸ºæ¯ä¸ªç±»åˆ«ç”Ÿæˆä¸“å±å…³é”®è¯
            const clusterAnalysis = Object.entries(categories).map(([name, questionList], index) => {
                // ä¸ºæ¯ä¸ªç±»åˆ«ç”Ÿæˆä¸“å±å…³é”®è¯
                const categoryKeywords = extractCategoryKeywords(questionList, keywords);
                
                return {
                    cluster_id: index,
                    name: name,
                    count: questionList.length,
                    keywords: categoryKeywords,
                    representative_questions: questionList.slice(0, 3),
                    all_questions: questionList,
                    percentage: (questionList.length / questions.length * 100).toFixed(1)
                };
            }).sort((a, b) => b.count - a.count);
            
            // ä¸ºæ¯ä¸ªç±»åˆ«æå–ä¸“å±å…³é”®è¯
            function extractCategoryKeywords(categoryQuestions, globalKeywords) {
                const categoryWordFreq = {};
                
                categoryQuestions.forEach(question => {
                    const words = segmentChinese(preprocessText(question));
                    words.forEach(word => {
                        if (word.length >= 2) {
                            categoryWordFreq[word] = (categoryWordFreq[word] || 0) + 1;
                        }
                    });
                });
                
                return Object.entries(categoryWordFreq)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([word, freq]) => word);
            }
            
            return {
                total_questions: questions.length,
                cluster_analysis: clusterAnalysis,
                top_keywords: keywords,
                custom_categories: Object.keys(config.custom_keywords || {}),
                analysis_time: new Date().toLocaleString()
            };
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayResults(results) {
            console.log('æ˜¾ç¤ºåˆ†æç»“æœ:', results);
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('total-questions').textContent = results.total_questions;
            document.getElementById('total-categories').textContent = results.cluster_analysis.length;
            document.getElementById('custom-categories-count').textContent = results.custom_categories.length;
            document.getElementById('top-keywords-count').textContent = results.top_keywords.length;
            
            // åˆ›å»ºåˆ†ç±»åˆ†å¸ƒå›¾è¡¨
            createCategoryChart(results.cluster_analysis);
            
            // åˆ›å»ºå…³é”®è¯å›¾è¡¨
            createKeywordsChart(results.top_keywords);
            
            // æ˜¾ç¤ºåˆ†ç±»åˆ—è¡¨
            displayCategoryList(results.cluster_analysis);
        }

        // åˆ›å»ºåˆ†ç±»åˆ†å¸ƒå›¾è¡¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        function createCategoryChart(clusterAnalysis) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // æ¸…é™¤ç°æœ‰å›¾è¡¨
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            const top10 = clusterAnalysis.slice(0, 10);
            
            // åŒºåˆ†è‡ªå®šä¹‰ç±»åˆ«å’Œè‡ªåŠ¨ç±»åˆ«çš„é¢œè‰²
            const colors = top10.map(cluster => {
                const isCustom = config.custom_keywords && config.custom_keywords[cluster.name];
                return isCustom ? 
                    ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'][top10.indexOf(cluster)] :
                    ['#BDC3C7', '#95A5A6', '#7F8C8D', '#34495E', '#2C3E50'][top10.indexOf(cluster) % 5];
            });
            
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top10.map(c => `${c.name} (${c.count}æ¡)`),
                    datasets: [{
                        data: top10.map(c => c.count),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cluster = top10[context.dataIndex];
                                    return `${cluster.name}: ${cluster.count}æ¡ (${cluster.percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºå…³é”®è¯å›¾è¡¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        function createKeywordsChart(keywords) {
            const ctx = document.getElementById('keywords-chart').getContext('2d');
            
            // æ¸…é™¤ç°æœ‰å›¾è¡¨
            if (window.keywordsChart) {
                window.keywordsChart.destroy();
            }
            
            const top10 = keywords.slice(0, 10);
            
            window.keywordsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(k => k.word),
                    datasets: [{
                        label: 'TF-IDFå¾—åˆ†',
                        data: top10.map(k => parseFloat(k.score)),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'TF-IDFå¾—åˆ†'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å…³é”®è¯'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x}: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºåˆ†ç±»åˆ—è¡¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        function displayCategoryList(clusterAnalysis) {
            const container = document.getElementById('category-list');
            container.innerHTML = '<h3>ğŸ† çƒ­ç‚¹é—®é¢˜æ’è¡Œæ¦œï¼ˆæŒ‰é—®é¢˜æ•°é‡æ’åºï¼‰</h3>';
            
            clusterAnalysis.forEach((cluster, index) => {
                const isCustom = config.custom_keywords && config.custom_keywords[cluster.name];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                // æ·»åŠ æ’åå¾½ç« 
                const rankBadge = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : `${index + 1}.`;
                
                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <span class="category-name">
                            ${rankBadge} ${cluster.name} 
                            ${isCustom ? 'ğŸ¯[è‡ªå®šä¹‰]' : '[è‡ªåŠ¨]'}
                        </span>
                        <span class="category-count">${cluster.count}æ¡ (${cluster.percentage}%)</span>
                    </div>
                    <div class="category-keywords">
                        <strong>æ ¸å¿ƒå…³é”®è¯ï¼š</strong>${cluster.keywords.slice(0, 5).join(' | ')}
                    </div>
                    <div class="category-examples">
                        <strong>ä»£è¡¨æ€§é—®é¢˜ï¼š</strong><br>
                        ${cluster.representative_questions.map(q => `â€¢ ${q}`).join('<br>')}
                        ${cluster.all_questions.length > 3 ? `<br><small style="color: #6c757d;">...è¿˜æœ‰${cluster.all_questions.length - 3}ä¸ªç›¸å…³é—®é¢˜</small>` : ''}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
            
            // æ·»åŠ åˆ†ææ€»ç»“
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'category-item';
            summaryDiv.style.background = '#f8f9fa';
            summaryDiv.style.border = '2px dashed #007bff';
            
            const customCount = clusterAnalysis.filter(c => config.custom_keywords && config.custom_keywords[c.name]).length;
            const autoCount = clusterAnalysis.length - customCount;
            
            summaryDiv.innerHTML = `
                <div style="text-align: center;">
                    <h4>ğŸ“Š åˆ†ææ€»ç»“</h4>
                    <p>
                        <strong>æ€»è®¡ï¼š</strong>${clusterAnalysis.length}ä¸ªé—®é¢˜ç±»åˆ« | 
                        <strong>è‡ªå®šä¹‰ç±»åˆ«ï¼š</strong>${customCount}ä¸ª | 
                        <strong>è‡ªåŠ¨ç±»åˆ«ï¼š</strong>${autoCount}ä¸ª
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        åˆ†æå®Œæˆæ—¶é—´ï¼š${analysisResults.analysis_time}
                    </p>
                </div>
            `;
            container.appendChild(summaryDiv);
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            if (!analysisResults) {
                alert('âŒ è¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            document.getElementById('export-progress').style.display = 'block';
            
            // æ¨¡æ‹Ÿå¯¼å‡ºè¿‡ç¨‹
            let progress = 0;
            const progressBar = document.getElementById('export-progress-fill');
            const statusText = document.getElementById('export-status');
            
            const updateProgress = () => {
                progress += 10;
                progressBar.style.width = progress + '%';
                statusText.textContent = `æ­£åœ¨å¯¼å‡º... ${progress}%`;
                
                if (progress >= 100) {
                    // åˆ›å»ºå¹¶ä¸‹è½½Excelæ–‡ä»¶
                    createExcelFile();
                    document.getElementById('export-progress').style.display = 'none';
                } else {
                    setTimeout(updateProgress, 200);
                }
            };
            
            updateProgress();
        }

        // åˆ›å»ºExcelæ–‡ä»¶
        function createExcelFile() {
            try {
                const wb = XLSX.utils.book_new();
                
                // å·¥ä½œè¡¨1ï¼šåˆ†ç±»ç»Ÿè®¡æ±‡æ€»
                const summaryData = analysisResults.cluster_analysis.map((cluster, index) => ({
                    'æ’å': index + 1,
                    'é—®é¢˜ç±»åˆ«': cluster.name,
                    'é—®é¢˜æ•°é‡': cluster.count,
                    'å æ¯”': cluster.percentage + '%',
                    'å…³é”®è¯': cluster.keywords.join(' | '),
                    'ä»£è¡¨é—®é¢˜': cluster.representative_questions.join(' | ')
                }));
                
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'åˆ†ç±»ç»Ÿè®¡æ±‡æ€»');
                
                // å·¥ä½œè¡¨2ï¼šè¯¦ç»†åˆ†æç»“æœ
                const detailData = [];
                analysisResults.cluster_analysis.forEach(cluster => {
                    cluster.all_questions.forEach(question => {
                        detailData.push({
                            'é—®é¢˜ç±»åˆ«': cluster.name,
                            'å…·ä½“é—®é¢˜': question,
                            'ç±»åˆ«é—®é¢˜æ€»æ•°': cluster.count,
                            'ç±»åˆ«å…³é”®è¯': cluster.keywords.join(' | ')
                        });
                    });
                });
                
                const detailWs = XLSX.utils.json_to_sheet(detailData);
                XLSX.utils.book_append_sheet(wb, detailWs, 'è¯¦ç»†åˆ†æç»“æœ');
                
                // å·¥ä½œè¡¨3ï¼šå…³é”®è¯åˆ†æ
                const keywordData = analysisResults.top_keywords.map((keyword, index) => ({
                    'æ’å': index + 1,
                    'å…³é”®è¯': keyword.word,
                    'TF-IDFå¾—åˆ†': keyword.score
                }));
                
                const keywordWs = XLSX.utils.json_to_sheet(keywordData);
                XLSX.utils.book_append_sheet(wb, keywordWs, 'å…³é”®è¯åˆ†æ');
                
                // ä¸‹è½½æ–‡ä»¶
                const fileName = `é—®é¢˜åˆ†æç»“æœ_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('âœ… å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½');
            } catch (error) {
                console.error('å¯¼å‡ºé”™è¯¯ï¼š', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }
    </script>
</body>
</html>
