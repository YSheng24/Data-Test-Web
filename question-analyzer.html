<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈóÆÈ¢òÂàÜÊûêÂô® - Êµ∑Â∫ïÊçûÊô∫ËÉΩÊï∞ÊçÆÂ§ÑÁêÜÂπ≥Âè∞</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* ÂØºËà™Ê†èÊ†∑Âºè */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .nav-brand .logo {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .nav-link {
            text-decoration: none;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .nav-link:hover {
            background: #007bff;
            color: white;
        }
        
        .nav-link.active {
            background: #007bff;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #0056b3;
            background: #f8f9ff;
        }
        
        .upload-section.dragover {
            border-color: #28a745;
            background: #f8fff8;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .category-list {
            margin-top: 20px;
        }
        
        .category-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .category-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .category-name {
            font-weight: 600;
            color: #495057;
        }
        
        .category-count {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .category-keywords {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .category-examples {
            font-size: 13px;
            color: #495057;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <span class="logo">üî•</span>
                Êµ∑Â∫ïÊçûÊô∫ËÉΩÊï∞ÊçÆÂ§ÑÁêÜÂπ≥Âè∞
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">üè† È¶ñÈ°µ</a>
                <a href="index.html" class="nav-link">üìä Êï∞ÊçÆÂ§ÑÁêÜ</a>
                <a href="department.html" class="nav-link">üè¢ ÈÉ®Èó®ÂàÜÁ±ª</a>
                <a href="question-analyzer.html" class="nav-link active">üîç ÈóÆÈ¢òÂàÜÊûê</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üîç ÈóÆÈ¢òÂàÜÊûêÂô®</h1>
            <p class="subtitle">Êô∫ËÉΩÈóÆÈ¢òÂàÜÁ±ª‰∏éÁÉ≠ÁÇπÂàÜÊûê‚Äî‚ÄîÂü∫‰∫éTF-IDFÁÆóÊ≥ïÁöÑÊñáÊú¨ÊåñÊéò</p>
        </div>
        
        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="upload">üìÅ Êï∞ÊçÆ‰∏ä‰º†</button>
                <button class="nav-tab" data-tab="config">‚öôÔ∏è ÈÖçÁΩÆËÆæÁΩÆ</button>
                <button class="nav-tab" data-tab="analysis">üìä ÂàÜÊûêÁªìÊûú</button>
                <button class="nav-tab" data-tab="export">üíæ ÂØºÂá∫‰∏ãËΩΩ</button>
            </div>
            
            <!-- Êï∞ÊçÆ‰∏ä‰º†Ê†áÁ≠æÈ°µ -->
            <div id="upload-tab" class="tab-content active">
                <div class="upload-section" id="upload-area">
                    <div>
                        <h3>üìÇ ‰∏ä‰º†ExcelÊàñCSVÊñá‰ª∂</h3>
                        <p style="margin: 15px 0; color: #6c757d;">
                            ÊîØÊåÅ .xlsx, .xls, .csv Ê†ºÂºèÔºåÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Âå∫ÂüüÊàñÁÇπÂáªÊåâÈíÆÈÄâÊã©
                        </p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv" />
                        <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                            ÈÄâÊã©Êñá‰ª∂
                        </button>
                        <div id="file-info" style="margin-top: 15px; color: #495057;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÈóÆÈ¢òÂàóÂêçÁß∞</label>
                    <input type="text" id="question-column" class="form-control" value="ÈóÆÈ¢ò" placeholder="ËæìÂÖ•ÂåÖÂê´ÈóÆÈ¢òÁöÑÂàóÂêç">
                    <small style="color: #6c757d;">ËØ∑Á°Æ‰øùÂàóÂêç‰∏éExcelÊñá‰ª∂‰∏≠ÁöÑÊ†áÈ¢òÂÆåÂÖ®‰∏ÄËá¥</small>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ËÅöÁ±ªÊï∞Èáè</label>
                        <input type="number" id="n-clusters" class="form-control" value="12" min="5" max="20">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ÂÖ≥ÈîÆËØçÊï∞Èáè</label>
                        <input type="number" id="top-keywords" class="form-control" value="25" min="10" max="50">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startAnalysis()" style="width: 100%; padding: 15px; font-size: 16px;">
                    üöÄ ÂºÄÂßãÂàÜÊûê
                </button>
            </div>
            
            <!-- ÈÖçÁΩÆËÆæÁΩÆÊ†áÁ≠æÈ°µ -->
            <div id="config-tab" class="tab-content">
                <div class="config-section">
                    <h3>üéØ Ëá™ÂÆö‰πâÁ±ªÂà´ÈÖçÁΩÆ</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">
                        ÈÄöËøáÂÖ≥ÈîÆËØçÂÆö‰πâÈóÆÈ¢òÂàÜÁ±ªÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Â∞ÜÂåÖÂê´Ëøô‰∫õÂÖ≥ÈîÆËØçÁöÑÈóÆÈ¢òÂΩíÁ±ªÂà∞ÂØπÂ∫îÁ±ªÂà´
                    </p>
                    
                    <div id="custom-categories">
                        <!-- Âä®ÊÄÅÁîüÊàêÁöÑÁ±ªÂà´ÈÖçÁΩÆ -->
                    </div>
                    
                    <button class="btn btn-success" onclick="addCustomCategory()">+ Ê∑ªÂä†Êñ∞Á±ªÂà´</button>
                </div>
                
                <div class="config-section">
                    <h3>üö´ ÂÅúÁî®ËØçÈÖçÁΩÆ</h3>
                    <label class="form-label">ÂøΩÁï•ÁöÑÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                    <textarea id="ignore-keywords" class="form-control" rows="3" 
                              placeholder="ÈóÆÈ¢ò,‰ªÄ‰πà,ÊÄé‰πà,Â¶Ç‰Ωï,ËØ∑ÈóÆ,Âí®ËØ¢,‰∫ÜËß£,Áü•ÈÅì">ÈóÆÈ¢ò,‰ªÄ‰πà,ÊÄé‰πà,Â¶Ç‰Ωï,ËØ∑ÈóÆ,Âí®ËØ¢,‰∫ÜËß£,Áü•ÈÅì,ÂèØ‰ª•,ËÉΩÂê¶,ÊòØÂê¶,ËÉΩ‰∏çËÉΩ,ÂèØ‰∏çÂèØ‰ª•,ÊúâÊ≤°Êúâ,Â§öÂ∞ë,Âì™Èáå</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="saveConfig()">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                <button class="btn btn-success" onclick="loadHaidilaoConfig()">üî• Âä†ËΩΩÊµ∑Â∫ïÊçûÈ¢ÑËÆæ</button>
            </div>
            
            <!-- ÂàÜÊûêÁªìÊûúÊ†áÁ≠æÈ°µ -->
            <div id="analysis-tab" class="tab-content">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®ÂàÜÊûê‰∏≠ÔºåËØ∑Á®çÂÄô...</p>
                </div>
                
                <div id="results-container" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-questions">0</div>
                            <div class="stat-label">ÊÄªÈóÆÈ¢òÊï∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-categories">0</div>
                            <div class="stat-label">ËØÜÂà´Á±ªÂà´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="custom-categories-count">0</div>
                            <div class="stat-label">Ëá™ÂÆö‰πâÁ±ªÂà´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="top-keywords-count">0</div>
                            <div class="stat-label">ÂÖ≥ÈîÆËØç</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">üìä ÈóÆÈ¢òÂàÜÁ±ªÂàÜÂ∏É</div>
                        <canvas id="category-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">üîç ÂÖ≥ÈîÆËØçÈáçË¶ÅÂ∫¶</div>
                        <canvas id="keywords-chart"></canvas>
                    </div>
                    
                    <div class="category-list" id="category-list">
                        <!-- Âä®ÊÄÅÁîüÊàêÁöÑÂàÜÁ±ªÂàóË°® -->
                    </div>
                </div>
            </div>
            
            <!-- ÂØºÂá∫‰∏ãËΩΩÊ†áÁ≠æÈ°µ -->
            <div id="export-tab" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3>üíæ ÂØºÂá∫ÂàÜÊûêÁªìÊûú</h3>
                    <p style="margin: 20px 0; color: #6c757d;">
                        Â∞ÜÂàÜÊûêÁªìÊûúÂØºÂá∫‰∏∫ExcelÊñá‰ª∂ÔºåÂåÖÂê´ÂéüÊï∞ÊçÆÂàÜÁ±ª„ÄÅÁªüËÆ°Ê±áÊÄª„ÄÅËØ¶ÁªÜÂàÜÊûêÁ≠âÂ§ö‰∏™Â∑•‰ΩúË°®
                    </p>
                    
                    <div style="margin: 30px 0;">
                        <button class="btn btn-success" onclick="exportResults()" style="padding: 15px 30px; font-size: 16px;">
                            üì• ‰∏ãËΩΩÂÆåÊï¥ÂàÜÊûêÁªìÊûú
                        </button>
                    </div>
                    
                    <div id="export-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="export-progress-fill"></div>
                        </div>
                        <p id="export-status">Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let fileData = null;
        let analysisResults = null;
        let config = {
            custom_keywords: {},
            ignore_keywords: new Set(['ÈóÆÈ¢ò', '‰ªÄ‰πà', 'ÊÄé‰πà', 'Â¶Ç‰Ωï', 'ËØ∑ÈóÆ', 'Âí®ËØ¢', '‰∫ÜËß£', 'Áü•ÈÅì'])
        };

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // ÂàùÂßãÂåñÈ°µÈù¢
        function initializePage() {
            // ÂàùÂßãÂåñÊ†áÁ≠æÈ°µ
            initializeTabs();
            
            // ÂàùÂßãÂåñÊñá‰ª∂‰∏ä‰º†
            initializeFileUpload();
            
            console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        }

        // ÂàùÂßãÂåñÊ†áÁ≠æÈ°µ
        function initializeTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        // Ê†áÁ≠æÈ°µÂàáÊç¢
        function switchTab(tabName) {
            console.log('ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabName);
            
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑactiveÁ±ª
            const allBtns = document.querySelectorAll('.nav-tab');
            allBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÊåáÂÆöÊ†áÁ≠æÈ°µ
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Ê∑ªÂä†ÂØπÂ∫îÊåâÈíÆÁöÑactiveÁ±ª
            const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        // ÂàùÂßãÂåñÊñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
        function initializeFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            // ÊãñÊãΩ‰∫ã‰ª∂
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // Â§ÑÁêÜÊñá‰ª∂
        function handleFile(file) {
            console.log('Â§ÑÁêÜÊñá‰ª∂:', file.name);
            const fileInfo = document.getElementById('file-info');
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            fileInfo.innerHTML = `
                <div class="success">
                    ‚úÖ Êñá‰ª∂Â∑≤ÈÄâÊã©Ôºö${fileName} (${fileSize} MB)
                </div>
            `;
            
            // ËØªÂèñÊñá‰ª∂
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (fileName.endsWith('.csv')) {
                        // Â§ÑÁêÜCSVÊñá‰ª∂
                        const csvData = e.target.result;
                        const parsed = Papa.parse(csvData, {
                            header: true,
                            skipEmptyLines: true,
                            encoding: 'UTF-8'
                        });
                        fileData = parsed.data;
                    } else {
                        // Â§ÑÁêÜExcelÊñá‰ª∂
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        fileData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    fileInfo.innerHTML += `
                        <div class="success">
                            üìä Êï∞ÊçÆËß£ÊûêÊàêÂäüÔºöÂÖ± ${fileData.length} Ë°åÊï∞ÊçÆ
                        </div>
                    `;
                    
                    // Ê£ÄÊµãÂàóÂêç
                    if (fileData.length > 0) {
                        const columns = Object.keys(fileData[0]);
                        console.log('Ê£ÄÊµãÂà∞ÁöÑÂàóÂêçÔºö', columns);
                        
                        // Êô∫ËÉΩÊ£ÄÊµãÈóÆÈ¢òÂàó
                        const questionColumns = columns.filter(col => 
                            col.includes('ÈóÆÈ¢ò') || col.includes('ÂÜÖÂÆπ') || col.includes('ÈóÆ')
                        );
                        
                        if (questionColumns.length > 0) {
                            document.getElementById('question-column').value = questionColumns[0];
                        }
                    }
                } catch (error) {
                    console.error('Êñá‰ª∂Ëß£ÊûêÈîôËØØ:', error);
                    fileInfo.innerHTML = `
                        <div class="error">
                            ‚ùå Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•Ôºö${error.message}
                        </div>
                    `;
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Ê∑ªÂä†Ëá™ÂÆö‰πâÁ±ªÂà´
        function addCustomCategory() {
            const container = document.getElementById('custom-categories');
            const categoryId = 'category_' + Date.now();
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'form-group';
            categoryDiv.innerHTML = `
                <label class="form-label">Á±ªÂà´ÂêçÁß∞</label>
                <input type="text" class="form-control category-name" placeholder="‰æãÂ¶ÇÔºöÂëòÂ∑•Â≤ó‰ΩçÁ±ª">
                <label class="form-label" style="margin-top: 10px;">ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                <input type="text" class="form-control category-keywords" placeholder="‰æãÂ¶ÇÔºöÂ≤ó‰ΩçÊµÅÁ®ã,ËÆ§ËØÅ,Âó®Â≠¶Â†Ç,ÂèòËÑ∏">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">Âà†Èô§Ê≠§Á±ªÂà´</button>
            `;
            
            container.appendChild(categoryDiv);
        }

        // ‰øùÂ≠òÈÖçÁΩÆ
        function saveConfig() {
            const customCategories = {};
            const categoryDivs = document.querySelectorAll('#custom-categories .form-group');
            
            categoryDivs.forEach(div => {
                const nameInput = div.querySelector('.category-name');
                const keywordsInput = div.querySelector('.category-keywords');
                
                if (nameInput && keywordsInput && nameInput.value && keywordsInput.value) {
                    const keywords = keywordsInput.value.split(',').map(k => k.trim()).filter(k => k);
                    customCategories[nameInput.value] = keywords;
                }
            });
            
            config.custom_keywords = customCategories;
            
            const ignoreKeywords = document.getElementById('ignore-keywords').value
                .split(',').map(k => k.trim()).filter(k => k);
            config.ignore_keywords = new Set(ignoreKeywords);
            
            console.log('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò:', config);
            alert('‚úÖ ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
        }

        // Âä†ËΩΩÊµ∑Â∫ïÊçûÈ¢ÑËÆæÈÖçÁΩÆ
        function loadHaidilaoConfig() {
            const haidilaoConfig = {
                "ÂëòÂ∑•Â≤ó‰ΩçÁ±ª": ["ËÄÉËØÅ‰π¶","ÊãÖÂΩìËØÅ‰π¶","Â≤ó‰ΩçÊµÅÁ®ã", "Â§ßÂ†ÇÁªèÁêÜÂ≤ó‰ΩçÊµÅÁ®ã", "Â§ßÂ†ÇÁªèÁêÜÊµÅÁ®ã", "ÂêéÂ†ÇÁªèÁêÜÂ≤ó‰ΩçÊµÅÁ®ã", "ÂêéÂ†ÇÁªèÁêÜÊµÅÁ®ã","Â≤ó‰ΩçÊ†áÂáÜ","Â≤ó‰ΩçËØÅ‰π¶","Â≤ó‰ΩçËÆ§ËØÅ","ËÆ§ËØÅ","Âó®Â≠¶Â†Ç","ÂèòËÑ∏","Â∫ìÁÆ°","ÂøÉËÇ∫Â§çËãè"],
                "ÊúçÂä°ÊäÄÂ∑ßÊèêÂçáÁ±ª": ["ÂëòÂ∑•", "ÂüπËÆ≠", "Â≠¶‰π†", "ËÄÉÊ†∏", "Áª©Êïà", "ÊôãÂçá", "ÂçáËÅå", "ËÅå‰∏öÂèëÂ±ï"],
                "ÊµÅÁ®ãÁõ∏ÂÖ≥ÈóÆÈ¢ò": ["ÊµÅÁ®ã", "ËßÑÂÆö", "ÊîøÁ≠ñ", "Ê†áÂáÜ", "Ë¶ÅÊ±Ç", "Êìç‰Ωú", "Âà∂Â∫¶"],
                "Â≤ó‰ΩçÁõ∏ÂÖ≥ÈóÆÈ¢ò": ["Â≤ó‰Ωç", "ËÅåË¥£", "Â∑•‰Ωú", "‰ªªÂä°", "ÂàÜÂ∑•", "ËÅå‰Ωç"],
                "Êµ∑Â∫ïÊçûÊúçÂä°": ["Êµ∑Â∫ïÊçû", "ÁâπËâ≤", "ÊñáÂåñ", "ÁêÜÂøµ", "ÂìÅÁâå"],
                "Èó®Â∫óËøêËê•ÁÆ°ÁêÜ": ["Èó®Â∫ó", "Â∫óÈù¢", "Ëê•‰∏ö", "ÂºÄÂ∫ó", "ÂÖ≥Â∫ó", "Ëê•‰∏öÊó∂Èó¥", "Â∫óÈïø", "Â∫óÁªèÁêÜ"],
                "È£üÂìÅÂÆâÂÖ®ÁÆ°ÁêÜ": ["È£üÂìÅ", "ÂÆâÂÖ®", "Âç´Áîü", "Ê∏ÖÊ¥Å", "Ê∂àÊØí", "È£üÊùê", "ËøáÊúü", "Êñ∞È≤ú"],
                "ÊéíÁè≠Ë∞ÉÂ∫¶ÁÆ°ÁêÜ": ["ÊéíÁè≠", "Ë∞ÉÁè≠", "Êç¢Áè≠", "ËØ∑ÂÅá", "‰ºëÂÅá", "Êó∂Èó¥", "Áè≠Ê¨°"],
                "Ëñ™ÈÖ¨Á¶èÂà©ÁÆ°ÁêÜ": ["Â∑•ËµÑ", "Ëñ™Ê∞¥", "Ëñ™ËµÑ", "Â•ñÈáë", "Ë°•Ë¥¥", "Á¶èÂà©", "‰øùÈô©"],
                "Êä•ÈîÄË¥πÁî®ÁÆ°ÁêÜ": ["Êä•ÈîÄ", "ÂèëÁ•®", "Ë¥πÁî®", "Â∑ÆÊóÖ", "‰∫§ÈÄö", "‰ΩèÂÆø", "È§êË¥π"],
                "ËÆæÂ§áÁª¥Êä§ÁÆ°ÁêÜ": ["ËÆæÂ§á", "Áª¥‰øÆ", "ÊïÖÈöú", "‰øùÂÖª", "Áª¥Êä§", "Êú∫Âô®", "Â∑•ÂÖ∑"],
                "‰ø°ÊÅØÁ≥ªÁªüÁÆ°ÁêÜ": ["Á≥ªÁªü", "ËΩØ‰ª∂", "ÁîµËÑë", "ÁΩëÁªú", "ÁôªÂΩï", "ÂØÜÁ†Å", "Á®ãÂ∫è"],
                "Â∫ìÂ≠òÁâ©ÊñôÁÆ°ÁêÜ": ["Â∫ìÂ≠ò", "Áâ©Êñô", "ÈááË¥≠", "ÈÖçÈÄÅ", "‰æõÂ∫î", "ÂÖ•Â∫ì", "Âá∫Â∫ì"]
            };
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÖçÁΩÆ
            document.getElementById('custom-categories').innerHTML = '';
            
            // Ê∑ªÂä†È¢ÑËÆæÈÖçÁΩÆ
            Object.entries(haidilaoConfig).forEach(([category, keywords]) => {
                addCustomCategory();
                const lastCategory = document.querySelector('#custom-categories .form-group:last-child');
                if (lastCategory) {
                    const nameInput = lastCategory.querySelector('.category-name');
                    const keywordsInput = lastCategory.querySelector('.category-keywords');
                    if (nameInput) nameInput.value = category;
                    if (keywordsInput) keywordsInput.value = keywords.join(', ');
                }
            });
            
            alert('‚úÖ Êµ∑Â∫ïÊçûÈ¢ÑËÆæÈÖçÁΩÆÂ∑≤Âä†ËΩΩÔºÅ');
        }

        // ÂºÄÂßãÂàÜÊûê
        function startAnalysis() {
            if (!fileData) {
                alert('‚ùå ËØ∑ÂÖà‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂');
                return;
            }
            
            // ‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ
            saveConfig();
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            
            // ÂàáÊç¢Âà∞ÂàÜÊûêÁªìÊûúÊ†áÁ≠æÈ°µ
            switchTab('analysis');
            
            // Ê®°ÊãüÂàÜÊûêËøáÁ®ã
            setTimeout(() => {
                performAnalysis();
            }, 1000);
        }

        // ÊâßË°åÂàÜÊûê
        function performAnalysis() {
            try {
                const questionColumn = document.getElementById('question-column').value;
                const nClusters = parseInt(document.getElementById('n-clusters').value);
                const topKeywords = parseInt(document.getElementById('top-keywords').value);
                
                // Ê£ÄÊü•ÈóÆÈ¢òÂàóÊòØÂê¶Â≠òÂú®
                if (!fileData[0] || !fileData[0][questionColumn]) {
                    throw new Error(`Êâæ‰∏çÂà∞ÂàóÂêçÔºö${questionColumn}`);
                }
                
                // ÊèêÂèñÈóÆÈ¢òÊï∞ÊçÆ
                const questions = fileData.map(row => row[questionColumn]).filter(q => q && q.trim());
                
                console.log('ÂºÄÂßãÂàÜÊûê', questions.length, '‰∏™ÈóÆÈ¢ò');
                
                // Â¢ûÂº∫ÁâàÂàÜÊûêÈÄªËæë
                const analysisResult = enhancedQuestionAnalysis(questions, config, nClusters);
                
                // ‰øùÂ≠òÁªìÊûú
                analysisResults = analysisResult;
                
                // ÊòæÁ§∫ÁªìÊûú
                displayResults(analysisResult);
                
                // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-container').style.display = 'block';
                
            } catch (error) {
                console.error('ÂàÜÊûêÈîôËØØÔºö', error);
                document.getElementById('loading').style.display = 'none';
                alert('‚ùå ÂàÜÊûêÂ§±Ë¥•Ôºö' + error.message);
            }
        }

        // Â¢ûÂº∫ÁâàÈóÆÈ¢òÂàÜÊûêÂáΩÊï∞
        function enhancedQuestionAnalysis(questions, config, nClusters) {
            console.log('ÊâßË°åÂ¢ûÂº∫ÁâàÈóÆÈ¢òÂàÜÊûê...');
            
            // ÊîπËøõÁöÑ‰∏≠ÊñáÊñáÊú¨Â§ÑÁêÜ
            function preprocessText(text) {
                if (!text) return '';
                // Ê∏ÖÁêÜHTMLÊ†áÁ≠æÂíåÁâπÊÆäÂ≠óÁ¨¶Ôºå‰øùÁïô‰∏≠ÊñáÂíåÂü∫Êú¨Ê†áÁÇπ
                return text.toString()
                    .replace(/<[^>]*>/g, '')
                    .replace(/[^\u4e00-\u9fa5a-zA-Z0-9Ôºå„ÄÇÔºÅÔºü„ÄÅÔºõÔºö""''ÔºàÔºâ„Äê„Äë]/g, ' ')
                    .toLowerCase()
                    .trim();
            }
            
            // ÊîπËøõÁöÑ‰∏≠ÊñáÂàÜËØç
            function segmentChinese(text) {
                const stopWords = config.ignore_keywords || new Set();
                const words = [];
                
                // Âü∫‰∫éÂ≠óÁ¨¶Á±ªÂûãÁöÑÁÆÄÂçïÂàÜËØç
                let currentWord = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    
                    if (/[\u4e00-\u9fa5]/.test(char)) {
                        // ‰∏≠ÊñáÂ≠óÁ¨¶
                        currentWord += char;
                        // Ê£ÄÊü•ÊòØÂê¶ÂΩ¢ÊàêÂ∏∏ËßÅËØçÊ±á
                        if (currentWord.length >= 2) {
                            if (!stopWords.has(currentWord) && currentWord.length <= 6) {
                                words.push(currentWord);
                            }
                            // ‰øùÊåÅÊªëÂä®Á™óÂè£
                            if (currentWord.length > 3) {
                                currentWord = currentWord.slice(-2);
                            }
                        }
                    } else if (/[a-zA-Z0-9]/.test(char)) {
                        // Ëã±ÊñáÊï∞Â≠ó
                        currentWord += char;
                    } else {
                        // ÂàÜÈöîÁ¨¶
                        if (currentWord.length > 1 && !stopWords.has(currentWord)) {
                            words.push(currentWord);
                        }
                        currentWord = '';
                    }
                }
                
                // Â§ÑÁêÜÊúÄÂêéÁöÑËØç
                if (currentWord.length > 1 && !stopWords.has(currentWord)) {
                    words.push(currentWord);
                }
                
                return words;
            }
            
            // TF-IDFÈ£éÊ†ºÁöÑÂÖ≥ÈîÆËØçÊèêÂèñ
            function extractKeywords(questions) {
                const wordFreq = {};
                const docFreq = {};
                const totalDocs = questions.length;
                
                // ËÆ°ÁÆóËØçÈ¢ëÂíåÊñáÊ°£È¢ëÁéá
                questions.forEach(question => {
                    const text = preprocessText(question);
                    const words = segmentChinese(text);
                    const uniqueWords = new Set(words);
                    
                    words.forEach(word => {
                        wordFreq[word] = (wordFreq[word] || 0) + 1;
                    });
                    
                    uniqueWords.forEach(word => {
                        docFreq[word] = (docFreq[word] || 0) + 1;
                    });
                });
                
                // ËÆ°ÁÆóTF-IDFÂàÜÊï∞
                const tfidfScores = {};
                Object.keys(wordFreq).forEach(word => {
                    const tf = wordFreq[word];
                    const df = docFreq[word];
                    const idf = Math.log(totalDocs / (df + 1));
                    tfidfScores[word] = tf * idf;
                });
                
                return Object.entries(tfidfScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 25)
                    .map(([word, score]) => ({ word, score: score.toFixed(3) }));
            }
            
            // ÊîπËøõÁöÑÈóÆÈ¢òÂàÜÁ±ª
            function categorizeQuestions(questions, config) {
                const categories = {};
                const uncategorized = [];
                
                questions.forEach((question, index) => {
                    let assigned = false;
                    let bestMatch = null;
                    let maxScore = 0;
                    
                    const questionText = preprocessText(question);
                    const questionWords = new Set(segmentChinese(questionText));
                    
                    // Ëá™ÂÆö‰πâÁ±ªÂà´ÂåπÈÖçÔºàÂü∫‰∫éÂÖ≥ÈîÆËØçË¶ÜÁõñÁéáÔºâ
                    if (config.custom_keywords) {
                        for (const [categoryName, keywords] of Object.entries(config.custom_keywords)) {
                            let matchScore = 0;
                            let matchCount = 0;
                            
                            keywords.forEach(keyword => {
                                const keywordLower = keyword.toLowerCase();
                                if (questionText.includes(keywordLower)) {
                                    matchCount++;
                                    matchScore += keyword.length; // ÈïøÂÖ≥ÈîÆËØçÊùÉÈáçÊõ¥È´ò
                                }
                            });
                            
                            if (matchCount > 0) {
                                const score = matchScore + (matchCount * 2);
                                if (score > maxScore) {
                                    maxScore = score;
                                    bestMatch = categoryName;
                                }
                            }
                        }
                    }
                    
                    if (bestMatch) {
                        if (!categories[bestMatch]) {
                            categories[bestMatch] = [];
                        }
                        categories[bestMatch].push(question);
                        assigned = true;
                    }
                    
                    if (!assigned) {
                        uncategorized.push(question);
                    }
                });
                
                // ÂØπÊú™ÂàÜÁ±ªÈóÆÈ¢òËøõË°åËá™Âä®ËÅöÁ±ª
                if (uncategorized.length > 0) {
                    const autoClusters = autoClusterQuestions(uncategorized, Math.min(5, Math.floor(uncategorized.length / 10)));
                    Object.assign(categories, autoClusters);
                }
                
                return categories;
            }
            
            // Ëá™Âä®ËÅöÁ±ªÊú™ÂàÜÁ±ªÈóÆÈ¢ò
            function autoClusterQuestions(questions, maxClusters) {
                if (questions.length === 0) return {};
                
                const clusters = {};
                const wordFreq = {};
                
                // ÁªüËÆ°Êú™ÂàÜÁ±ªÈóÆÈ¢ò‰∏≠ÁöÑÈ´òÈ¢ëËØç
                questions.forEach(question => {
                    const words = segmentChinese(preprocessText(question));
                    words.forEach(word => {
                        if (word.length >= 2) {
                            wordFreq[word] = (wordFreq[word] || 0) + 1;
                        }
                    });
                });
                
                // ÊâæÂá∫È´òÈ¢ëÂÖ≥ÈîÆËØç‰Ωú‰∏∫ËÅöÁ±ª‰∏≠ÂøÉ
                const topWords = Object.entries(wordFreq)
                    .filter(([word, freq]) => freq >= 2)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, maxClusters)
                    .map(([word, freq]) => word);
                
                // Âü∫‰∫éÂÖ≥ÈîÆËØçËøõË°åËÅöÁ±ª
                const assigned = new Set();
                topWords.forEach(centerWord => {
                    const clusterQuestions = [];
                    
                    questions.forEach((question, index) => {
                        if (assigned.has(index)) return;
                        
                        const questionText = preprocessText(question);
                        if (questionText.includes(centerWord)) {
                            clusterQuestions.push(question);
                            assigned.add(index);
                        }
                    });
                    
                    if (clusterQuestions.length > 0) {
                        clusters[`${centerWord}Áõ∏ÂÖ≥ÈóÆÈ¢ò`] = clusterQuestions;
                    }
                });
                
                // Ââ©‰ΩôÊú™ÂàÜÁ±ªÁöÑÂΩí‰∏∫"ÂÖ∂‰ªñÈóÆÈ¢ò"
                const remaining = questions.filter((q, index) => !assigned.has(index));
                if (remaining.length > 0) {
                    clusters['ÂÖ∂‰ªñÈóÆÈ¢ò'] = remaining;
                }
                
                return clusters;
            }
            
            const keywords = extractKeywords(questions);
            const categories = categorizeQuestions(questions, config);
            
            // ËΩ¨Êç¢‰∏∫ÂàÜÊûêÁªìÊûúÊ†ºÂºèÔºåÂπ∂‰∏∫ÊØè‰∏™Á±ªÂà´ÁîüÊàê‰∏ìÂ±ûÂÖ≥ÈîÆËØç
            const clusterAnalysis = Object.entries(categories).map(([name, questionList], index) => {
                // ‰∏∫ÊØè‰∏™Á±ªÂà´ÁîüÊàê‰∏ìÂ±ûÂÖ≥ÈîÆËØç
                const categoryKeywords = extractCategoryKeywords(questionList, keywords);
                
                return {
                    cluster_id: index,
                    name: name,
                    count: questionList.length,
                    keywords: categoryKeywords,
                    representative_questions: questionList.slice(0, 3),
                    all_questions: questionList,
                    percentage: (questionList.length / questions.length * 100).toFixed(1)
                };
            }).sort((a, b) => b.count - a.count);
            
            // ‰∏∫ÊØè‰∏™Á±ªÂà´ÊèêÂèñ‰∏ìÂ±ûÂÖ≥ÈîÆËØç
            function extractCategoryKeywords(categoryQuestions, globalKeywords) {
                const categoryWordFreq = {};
                
                categoryQuestions.forEach(question => {
                    const words = segmentChinese(preprocessText(question));
                    words.forEach(word => {
                        if (word.length >= 2) {
                            categoryWordFreq[word] = (categoryWordFreq[word] || 0) + 1;
                        }
                    });
                });
                
                return Object.entries(categoryWordFreq)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([word, freq]) => word);
            }
            
            return {
                total_questions: questions.length,
                cluster_analysis: clusterAnalysis,
                top_keywords: keywords,
                custom_categories: Object.keys(config.custom_keywords || {}),
                analysis_time: new Date().toLocaleString()
            };
        }

        // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
        function displayResults(results) {
            console.log('ÊòæÁ§∫ÂàÜÊûêÁªìÊûú:', results);
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            document.getElementById('total-questions').textContent = results.total_questions;
            document.getElementById('total-categories').textContent = results.cluster_analysis.length;
            document.getElementById('custom-categories-count').textContent = results.custom_categories.length;
            document.getElementById('top-keywords-count').textContent = results.top_keywords.length;
            
            // ÂàõÂª∫ÂàÜÁ±ªÂàÜÂ∏ÉÂõæË°®
            createCategoryChart(results.cluster_analysis);
            
            // ÂàõÂª∫ÂÖ≥ÈîÆËØçÂõæË°®
            createKeywordsChart(results.top_keywords);
            
            // ÊòæÁ§∫ÂàÜÁ±ªÂàóË°®
            displayCategoryList(results.cluster_analysis);
        }

        // ÂàõÂª∫ÂàÜÁ±ªÂàÜÂ∏ÉÂõæË°®ÔºàÊîπËøõÁâàÔºâ
        function createCategoryChart(clusterAnalysis) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // Ê∏ÖÈô§Áé∞ÊúâÂõæË°®
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            const top10 = clusterAnalysis.slice(0, 10);
            
            // Âå∫ÂàÜËá™ÂÆö‰πâÁ±ªÂà´ÂíåËá™Âä®Á±ªÂà´ÁöÑÈ¢úËâ≤
            const colors = top10.map(cluster => {
                const isCustom = config.custom_keywords && config.custom_keywords[cluster.name];
                return isCustom ? 
                    ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'][top10.indexOf(cluster)] :
                    ['#BDC3C7', '#95A5A6', '#7F8C8D', '#34495E', '#2C3E50'][top10.indexOf(cluster) % 5];
            });
            
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top10.map(c => `${c.name} (${c.count}Êù°)`),
                    datasets: [{
                        data: top10.map(c => c.count),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const cluster = top10[context.dataIndex];
                                    return `${cluster.name}: ${cluster.count}Êù° (${cluster.percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ÂàõÂª∫ÂÖ≥ÈîÆËØçÂõæË°®ÔºàÊîπËøõÁâàÔºâ
        function createKeywordsChart(keywords) {
            const ctx = document.getElementById('keywords-chart').getContext('2d');
            
            // Ê∏ÖÈô§Áé∞ÊúâÂõæË°®
            if (window.keywordsChart) {
                window.keywordsChart.destroy();
            }
            
            const top10 = keywords.slice(0, 10);
            
            window.keywordsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(k => k.word),
                    datasets: [{
                        label: 'TF-IDFÂæóÂàÜ',
                        data: top10.map(k => parseFloat(k.score)),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'TF-IDFÂæóÂàÜ'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ÂÖ≥ÈîÆËØç'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x}: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ÊòæÁ§∫ÂàÜÁ±ªÂàóË°®ÔºàÊîπËøõÁâàÔºâ
        function displayCategoryList(clusterAnalysis) {
            const container = document.getElementById('category-list');
            container.innerHTML = '<h3>üèÜ ÁÉ≠ÁÇπÈóÆÈ¢òÊéíË°åÊ¶úÔºàÊåâÈóÆÈ¢òÊï∞ÈáèÊéíÂ∫èÔºâ</h3>';
            
            clusterAnalysis.forEach((cluster, index) => {
                const isCustom = config.custom_keywords && config.custom_keywords[cluster.name];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                // Ê∑ªÂä†ÊéíÂêçÂæΩÁ´†
                const rankBadge = index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `${index + 1}.`;
                
                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <span class="category-name">
                            ${rankBadge} ${cluster.name} 
                            ${isCustom ? 'üéØ[Ëá™ÂÆö‰πâ]' : '[Ëá™Âä®]'}
                        </span>
                        <span class="category-count">${cluster.count}Êù° (${cluster.percentage}%)</span>
                    </div>
                    <div class="category-keywords">
                        <strong>Ê†∏ÂøÉÂÖ≥ÈîÆËØçÔºö</strong>${cluster.keywords.slice(0, 5).join(' | ')}
                    </div>
                    <div class="category-examples">
                        <strong>‰ª£Ë°®ÊÄßÈóÆÈ¢òÔºö</strong><br>
                        ${cluster.representative_questions.map(q => `‚Ä¢ ${q}`).join('<br>')}
                        ${cluster.all_questions.length > 3 ? `<br><small style="color: #6c757d;">...ËøòÊúâ${cluster.all_questions.length - 3}‰∏™Áõ∏ÂÖ≥ÈóÆÈ¢ò</small>` : ''}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
            
            // Ê∑ªÂä†ÂàÜÊûêÊÄªÁªì
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'category-item';
            summaryDiv.style.background = '#f8f9fa';
            summaryDiv.style.border = '2px dashed #007bff';
            
            const customCount = clusterAnalysis.filter(c => config.custom_keywords && config.custom_keywords[c.name]).length;
            const autoCount = clusterAnalysis.length - customCount;
            
            summaryDiv.innerHTML = `
                <div style="text-align: center;">
                    <h4>üìä ÂàÜÊûêÊÄªÁªì</h4>
                    <p>
                        <strong>ÊÄªËÆ°Ôºö</strong>${clusterAnalysis.length}‰∏™ÈóÆÈ¢òÁ±ªÂà´ | 
                        <strong>Ëá™ÂÆö‰πâÁ±ªÂà´Ôºö</strong>${customCount}‰∏™ | 
                        <strong>Ëá™Âä®Á±ªÂà´Ôºö</strong>${autoCount}‰∏™
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        ÂàÜÊûêÂÆåÊàêÊó∂Èó¥Ôºö${analysisResults.analysis_time}
                    </p>
                </div>
            `;
            container.appendChild(summaryDiv);
        }

        // ÂØºÂá∫ÁªìÊûú
        function exportResults() {
            if (!analysisResults) {
                alert('‚ùå ËØ∑ÂÖàËøõË°åÂàÜÊûê');
                return;
            }
            
            document.getElementById('export-progress').style.display = 'block';
            
            // Ê®°ÊãüÂØºÂá∫ËøáÁ®ã
            let progress = 0;
            const progressBar = document.getElementById('export-progress-fill');
            const statusText = document.getElementById('export-status');
            
            const updateProgress = () => {
                progress += 10;
                progressBar.style.width = progress + '%';
                statusText.textContent = `Ê≠£Âú®ÂØºÂá∫... ${progress}%`;
                
                if (progress >= 100) {
                    // ÂàõÂª∫Âπ∂‰∏ãËΩΩExcelÊñá‰ª∂
                    createExcelFile();
                    document.getElementById('export-progress').style.display = 'none';
                } else {
                    setTimeout(updateProgress, 200);
                }
            };
            
            updateProgress();
        }

        // ÂàõÂª∫ExcelÊñá‰ª∂
        function createExcelFile() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Â∑•‰ΩúË°®1ÔºöÂàÜÁ±ªÁªüËÆ°Ê±áÊÄª
                const summaryData = analysisResults.cluster_analysis.map((cluster, index) => ({
                    'ÊéíÂêç': index + 1,
                    'ÈóÆÈ¢òÁ±ªÂà´': cluster.name,
                    'ÈóÆÈ¢òÊï∞Èáè': cluster.count,
                    'Âç†ÊØî': cluster.percentage + '%',
                    'ÂÖ≥ÈîÆËØç': cluster.keywords.join(' | '),
                    '‰ª£Ë°®ÈóÆÈ¢ò': cluster.representative_questions.join(' | ')
                }));
                
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'ÂàÜÁ±ªÁªüËÆ°Ê±áÊÄª');
                
                // Â∑•‰ΩúË°®2ÔºöËØ¶ÁªÜÂàÜÊûêÁªìÊûú
                const detailData = [];
                analysisResults.cluster_analysis.forEach(cluster => {
                    cluster.all_questions.forEach(question => {
                        detailData.push({
                            'ÈóÆÈ¢òÁ±ªÂà´': cluster.name,
                            'ÂÖ∑‰ΩìÈóÆÈ¢ò': question,
                            'Á±ªÂà´ÈóÆÈ¢òÊÄªÊï∞': cluster.count,
                            'Á±ªÂà´ÂÖ≥ÈîÆËØç': cluster.keywords.join(' | ')
                        });
                    });
                });
                
                const detailWs = XLSX.utils.json_to_sheet(detailData);
                XLSX.utils.book_append_sheet(wb, detailWs, 'ËØ¶ÁªÜÂàÜÊûêÁªìÊûú');
                
                // Â∑•‰ΩúË°®3ÔºöÂÖ≥ÈîÆËØçÂàÜÊûê
                const keywordData = analysisResults.top_keywords.map((keyword, index) => ({
                    'ÊéíÂêç': index + 1,
                    'ÂÖ≥ÈîÆËØç': keyword.word,
                    'TF-IDFÂæóÂàÜ': keyword.score
                }));
                
                const keywordWs = XLSX.utils.json_to_sheet(keywordData);
                XLSX.utils.book_append_sheet(wb, keywordWs, 'ÂÖ≥ÈîÆËØçÂàÜÊûê');
                
                // ‰∏ãËΩΩÊñá‰ª∂
                const fileName = `ÈóÆÈ¢òÂàÜÊûêÁªìÊûú_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ ÂØºÂá∫ÊàêÂäüÔºÅÊñá‰ª∂Â∑≤‰∏ãËΩΩ');
            } catch (error) {
                console.error('ÂØºÂá∫ÈîôËØØÔºö', error);
                alert('‚ùå ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
    </script>
</body>
</html>
