<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能问题去重系统 - 海底捞智能数据处理平台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .container { padding-top: 2rem; }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem;
        }
        .feature-card {
            transition: transform 0.3s ease;
            height: 100%;
            background: rgba(255,255,255,0.9);
        }
        .feature-card:hover { transform: translateY(-5px); }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover { border-color: #667eea; background: #f0f4ff; }
        .upload-area.dragover { border-color: #667eea; background: #e7f1ff; }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
        }
        .progress-container { display: none; margin: 2rem 0; }
        .result-section { display: none; margin-top: 2rem; }
        .navbar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .navbar-brand, .nav-link { color: white !important; }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .processing-steps {
            display: none;
            margin-top: 1rem;
        }
        .step-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }
        .step-item.active { background: rgba(102, 126, 234, 0.2); }
        .step-item.completed { background: rgba(34, 197, 94, 0.2); }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-fire me-2"></i>海底捞智能数据处理平台
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>首页</a>
                <a class="nav-link" href="department.html"><i class="fas fa-building me-1"></i>部门分类</a>
                <a class="nav-link" href="question-analyzer.html"><i class="fas fa-search me-1"></i>问题分析</a>
                <a class="nav-link active" href="question-deduplication.html"><i class="fas fa-filter me-1"></i>智能去重</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 标题区域 -->
        <div class="row mb-4">
            <div class="col-12 text-center text-white">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-brain me-3"></i>智能问题去重系统
                </h1>
                <p class="lead">高级文本相似度分析 + 智能分层抽样</p>
            </div>
        </div>

        <!-- 功能介绍 -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-equals fa-3x text-primary mb-3"></i>
                        <h5>精确去重</h5>
                        <p class="text-muted">识别完全相同的问题表述</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-3x text-success mb-3"></i>
                        <h5>智能相似度</h5>
                        <p class="text-muted">多算法文本相似度检测</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                        <h5>分层抽样</h5>
                        <p class="text-muted">按部门智能分层抽样</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要功能区域 -->
        <div class="row">
            <!-- 问题去重 -->
            <div class="col-lg-6 mb-4">
                <div class="card position-relative">
                    <div class="status-badge bg-success text-white" id="deduplicationStatus" style="display: none;">
                        <i class="fas fa-check me-1"></i>就绪
                    </div>
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-filter me-2"></i>问题去重处理
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="deduplicationForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-database me-2"></i>全量数据文件
                                </label>
                                <div class="upload-area" onclick="document.getElementById('allDataFile').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <p class="mb-1">点击或拖拽上传Excel文件</p>
                                    <small class="text-muted">需包含"问题"和"对应部门"列</small>
                                </div>
                                <input type="file" id="allDataFile" accept=".xlsx,.xls" style="display: none;">
                                <div id="allDataFileName" class="mt-2"></div>
                                <div id="allDataPreview" class="mt-2" style="display: none;">
                                    <small class="text-success">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="allDataInfo"></span>
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-check-circle me-2"></i>已复核问题文件
                                </label>
                                <div class="upload-area" onclick="document.getElementById('checkedDataFile').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <p class="mb-1">点击或拖拽上传Excel文件</p>
                                    <small class="text-muted">需包含"问题"列</small>
                                </div>
                                <input type="file" id="checkedDataFile" accept=".xlsx,.xls" style="display: none;">
                                <div id="checkedDataFileName" class="mt-2"></div>
                                <div id="checkedDataPreview" class="mt-2" style="display: none;">
                                    <small class="text-success">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="checkedDataInfo"></span>
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-sliders-h me-2"></i>相似度算法选择
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="algorithm" id="jaccard" value="jaccard" checked>
                                    <label class="form-check-label" for="jaccard">
                                        <strong>Jaccard相似度</strong> - 适合短文本，快速处理
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="algorithm" id="cosine" value="cosine">
                                    <label class="form-check-label" for="cosine">
                                        <strong>余弦相似度</strong> - 适合长文本，准确度高
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="algorithm" id="levenshtein" value="levenshtein">
                                    <label class="form-check-label" for="levenshtein">
                                        <strong>编辑距离</strong> - 字符级别相似度
                                    </label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">相似度阈值: <strong id="thresholdValue">0.7</strong></label>
                                <input type="range" class="form-range" id="thresholdSlider" min="0.5" max="0.95" step="0.05" value="0.7">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">0.5 (宽松)</small>
                                    <small class="text-muted">0.95 (严格)</small>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100" id="deduplicationSubmit">
                                <i class="fas fa-play me-2"></i>开始智能去重
                            </button>
                        </form>

                        <!-- 处理步骤显示 -->
                        <div class="processing-steps" id="deduplicationSteps">
                            <h6 class="mt-3 mb-2">处理进度：</h6>
                            <div class="step-item" id="step1">
                                <i class="fas fa-circle-notch fa-spin me-2"></i>读取Excel文件...
                            </div>
                            <div class="step-item" id="step2">
                                <i class="fas fa-clock me-2"></i>数据预处理和清洗...
                            </div>
                            <div class="step-item" id="step3">
                                <i class="fas fa-clock me-2"></i>精确去重匹配...
                            </div>
                            <div class="step-item" id="step4">
                                <i class="fas fa-clock me-2"></i>相似度计算分析...
                            </div>
                            <div class="step-item" id="step5">
                                <i class="fas fa-clock me-2"></i>生成结果报告...
                            </div>
                        </div>

                        <div class="progress-container">
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <small id="progressText">准备中...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分层抽样 -->
            <div class="col-lg-6 mb-4">
                <div class="card position-relative">
                    <div class="status-badge bg-info text-white" id="samplingStatus" style="display: none;">
                        <i class="fas fa-check me-1"></i>就绪
                    </div>
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>智能分层抽样
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="samplingForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file-excel me-2"></i>数据文件
                                </label>
                                <div class="upload-area" onclick="document.getElementById('samplingDataFile').click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                    <p class="mb-1">点击或拖拽上传Excel文件</p>
                                    <small class="text-muted">需包含部门分类列</small>
                                </div>
                                <input type="file" id="samplingDataFile" accept=".xlsx,.xls" style="display: none;">
                                <div id="samplingDataFileName" class="mt-2"></div>
                                <div id="samplingDataPreview" class="mt-2" style="display: none;">
                                    <small class="text-success">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="samplingDataInfo"></span>
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-target me-2"></i>目标抽样数量
                                    </label>
                                    <input type="number" class="form-control" id="sampleSize" value="1500" min="100" max="10000">
                                    <small class="text-muted">建议范围: 100-10000</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-building me-2"></i>小部门阈值
                                    </label>
                                    <input type="number" class="form-control" id="smallDeptThreshold" value="50" min="10" max="200">
                                    <small class="text-muted">数据量≤此值的部门全部抽取</small>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-columns me-2"></i>部门列名
                                </label>
                                <input type="text" class="form-control" id="departmentColumn" value="对应部门" placeholder="对应部门">
                                <small class="text-muted">请输入Excel中部门列的确切名称</small>
                            </div>

                            <button type="submit" class="btn btn-success w-100" id="samplingSubmit">
                                <i class="fas fa-chart-line me-2"></i>开始分层抽样
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示区域 -->
        <div class="result-section">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>处理结果
                    </h4>
                </div>
                <div class="card-body">
                    <div id="resultContent">
                        <!-- 结果内容将在这里显示 -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary me-2" id="downloadBtn" style="display: none;">
                            <i class="fas fa-download me-2"></i>下载处理结果
                        </button>
                        <button class="btn btn-outline-secondary" id="newProcessBtn" style="display: none;">
                            <i class="fas fa-redo me-2"></i>重新处理
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let processedData = null;
        let currentProcessType = '';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupDragAndDrop();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 阈值滑块
            document.getElementById('thresholdSlider').addEventListener('input', function(e) {
                document.getElementById('thresholdValue').textContent = e.target.value;
            });

            // 文件上传
            setupFileUpload('allDataFile', 'allDataFileName', 'allDataPreview', 'allDataInfo', validateDeduplicationFile);
            setupFileUpload('checkedDataFile', 'checkedDataFileName', 'checkedDataPreview', 'checkedDataInfo', validateDeduplicationFile);
            setupFileUpload('samplingDataFile', 'samplingDataFileName', 'samplingDataPreview', 'samplingDataInfo', validateSamplingFile);

            // 表单提交
            document.getElementById('deduplicationForm').addEventListener('submit', handleDeduplicationSubmit);
            document.getElementById('samplingForm').addEventListener('submit', handleSamplingSubmit);

            // 重新处理按钮
            document.getElementById('newProcessBtn').addEventListener('click', function() {
                document.querySelector('.result-section').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'none';
                this.style.display = 'none';
            });
        }

        // 文件上传处理
        function setupFileUpload(fileInputId, fileNameId, previewId, infoId, validator) {
            const fileInput = document.getElementById(fileInputId);
            const fileName = document.getElementById(fileNameId);
            const preview = document.getElementById(previewId);
            const info = document.getElementById(infoId);
            
            fileInput.addEventListener('change', async function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    fileName.innerHTML = `<i class="fas fa-file-excel text-success me-2"></i>已选择: <strong>${file.name}</strong>`;
                    fileName.className = 'mt-2 text-success';
                    
                    try {
                        const data = await readExcelFile(file);
                        const validationResult = validator(data);
                        
                        if (validationResult.valid) {
                            info.textContent = validationResult.message;
                            preview.style.display = 'block';
                            updateStatus(fileInputId);
                        } else {
                            throw new Error(validationResult.message);
                        }
                    } catch (error) {
                        fileName.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i>文件错误: ${error.message}`;
                        fileName.className = 'mt-2 text-danger';
                        preview.style.display = 'none';
                    }
                }
            });
        }

        // 读取Excel文件
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(worksheet);
                        resolve(data);
                    } catch (error) {
                        reject(new Error('Excel文件格式错误'));
                    }
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsBinaryString(file);
            });
        }

        // 验证去重文件
        function validateDeduplicationFile(data) {
            if (!data || data.length === 0) {
                return { valid: false, message: '文件为空或无有效数据' };
            }

            const hasQuestionCol = data.some(row => 
                Object.keys(row).some(key => key.includes('问题'))
            );

            if (!hasQuestionCol) {
                return { valid: false, message: '未找到"问题"相关列' };
            }

            const questionCount = data.length;
            const validQuestions = data.filter(row => 
                Object.values(row).some(val => val && val.toString().trim().length > 0)
            ).length;

            return {
                valid: true,
                message: `共 ${questionCount} 行数据，有效问题 ${validQuestions} 条`
            };
        }

        // 验证抽样文件
        function validateSamplingFile(data) {
            if (!data || data.length === 0) {
                return { valid: false, message: '文件为空或无有效数据' };
            }

            const deptCol = document.getElementById('departmentColumn').value || '对应部门';
            const hasDeptCol = data.some(row => 
                Object.keys(row).some(key => key.includes(deptCol) || key.includes('部门'))
            );

            if (!hasDeptCol) {
                return { valid: false, message: `未找到"${deptCol}"相关列` };
            }

            const totalCount = data.length;
            const deptCount = new Set(data.map(row => 
                Object.values(row).find(val => val && val.toString().includes('部'))
            )).size;

            return {
                valid: true,
                message: `共 ${totalCount} 行数据，包含约 ${deptCount} 个部门`
            };
        }

        // 更新状态指示器
        function updateStatus(fileInputId) {
            const allReady = document.getElementById('allDataFile').files.length > 0 && 
                           document.getElementById('checkedDataFile').files.length > 0;
            const samplingReady = document.getElementById('samplingDataFile').files.length > 0;

            if (allReady) {
                const status = document.getElementById('deduplicationStatus');
                status.style.display = 'block';
            }

            if (samplingReady) {
                const status = document.getElementById('samplingStatus');
                status.style.display = 'block';
            }
        }

        // 文本相似度计算函数
        function calculateJaccardSimilarity(str1, str2) {
            const set1 = new Set(str1.toLowerCase().split(''));
            const set2 = new Set(str2.toLowerCase().split(''));
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            const union = new Set([...set1, ...set2]);
            return intersection.size / union.size;
        }

        function calculateCosineSimilarity(str1, str2) {
            const getVector = (str) => {
                const words = str.toLowerCase().split('');
                const vector = {};
                words.forEach(word => {
                    vector[word] = (vector[word] || 0) + 1;
                });
                return vector;
            };

            const vec1 = getVector(str1);
            const vec2 = getVector(str2);
            const allKeys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);

            let dotProduct = 0;
            let norm1 = 0;
            let norm2 = 0;

            allKeys.forEach(key => {
                const val1 = vec1[key] || 0;
                const val2 = vec2[key] || 0;
                dotProduct += val1 * val2;
                norm1 += val1 * val1;
                norm2 += val2 * val2;
            });

            return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2)) || 0;
        }

        function calculateLevenshteinSimilarity(str1, str2) {
            const getEditDistance = (s1, s2) => {
                const matrix = Array(s2.length + 1).fill().map(() => Array(s1.length + 1).fill(0));
                
                for (let i = 0; i <= s1.length; i++) matrix[0][i] = i;
                for (let j = 0; j <= s2.length; j++) matrix[j][0] = j;
                
                for (let j = 1; j <= s2.length; j++) {
                    for (let i = 1; i <= s1.length; i++) {
                        if (s1[i-1] === s2[j-1]) {
                            matrix[j][i] = matrix[j-1][i-1];
                        } else {
                            matrix[j][i] = Math.min(
                                matrix[j-1][i-1] + 1,
                                matrix[j][i-1] + 1,
                                matrix[j-1][i] + 1
                            );
                        }
                    }
                }
                return matrix[s2.length][s1.length];
            };

            const maxLen = Math.max(str1.length, str2.length);
            if (maxLen === 0) return 1;
            return (maxLen - getEditDistance(str1, str2)) / maxLen;
        }

        // 计算相似度
        function calculateSimilarity(str1, str2, algorithm) {
            if (str1 === str2) return 1;
            if (!str1 || !str2) return 0;

            switch (algorithm) {
                case 'jaccard':
                    return calculateJaccardSimilarity(str1, str2);
                case 'cosine':
                    return calculateCosineSimilarity(str1, str2);
                case 'levenshtein':
                    return calculateLevenshteinSimilarity(str1, str2);
                default:
                    return calculateJaccardSimilarity(str1, str2);
            }
        }

        // 处理去重提交
        async function handleDeduplicationSubmit(e) {
            e.preventDefault();
            
            const allDataFile = document.getElementById('allDataFile').files[0];
            const checkedDataFile = document.getElementById('checkedDataFile').files[0];
            const threshold = parseFloat(document.getElementById('thresholdSlider').value);
            const algorithm = document.querySelector('input[name="algorithm"]:checked').value;
            
            if (!allDataFile || !checkedDataFile) {
                alert('请先选择两个Excel文件！');
                return;
            }

            currentProcessType = 'deduplication';
            await processWithSteps(async () => {
                const allData = await readExcelFile(allDataFile);
                const checkedData = await readExcelFile(checkedDataFile);
                return processDeduplication(allData, checkedData, threshold, algorithm);
            }, 'deduplicationSteps', 'deduplicationSubmit');
        }

        // 处理抽样提交
        async function handleSamplingSubmit(e) {
            e.preventDefault();
            
            const dataFile = document.getElementById('samplingDataFile').files[0];
            const sampleSize = parseInt(document.getElementById('sampleSize').value);
            const threshold = parseInt(document.getElementById('smallDeptThreshold').value);
            const departmentCol = document.getElementById('departmentColumn').value;
            
            if (!dataFile) {
                alert('请先选择Excel文件！');
                return;
            }

            currentProcessType = 'sampling';
            await processWithSteps(async () => {
                const data = await readExcelFile(dataFile);
                return processStratifiedSampling(data, sampleSize, threshold, departmentCol);
            }, null, 'samplingSubmit');
        }

        // 带步骤的处理函数
        async function processWithSteps(processFunc, stepsId, submitBtnId) {
            const submitBtn = document.getElementById(submitBtnId);
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';

            try {
                let result;
                
                if (stepsId) {
                    const stepsContainer = document.getElementById(stepsId);
                    stepsContainer.style.display = 'block';
                    
                    // 逐步执行，同时进行实际处理
                    await updateStep('step1', '读取Excel文件...', 200);
                    await updateStep('step2', '数据预处理和清洗...', 300);
                    await updateStep('step3', '精确去重匹配...', 200);
                    
                    // 在第4步时开始实际处理
                    document.getElementById('step4').classList.add('active');
                    document.getElementById('step4').innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>相似度计算分析...';
                    
                    result = await processFunc();
                    
                    await updateStep('step4', '相似度计算分析...', 100);
                    await updateStep('step5', '生成结果报告...', 200);
                    
                    stepsContainer.style.display = 'none';
                } else {
                    result = await processFunc();
                }
                
                showResult(result);
                
            } catch (error) {
                console.error('处理出错:', error);
                alert(`处理失败: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // 更新处理步骤
        async function updateStep(stepId, message, delay) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const step = document.getElementById(stepId);
                    if (step) {
                        step.classList.add('active');
                        step.innerHTML = `<i class="fas fa-circle-notch fa-spin me-2"></i>${message}`;
                        
                        setTimeout(() => {
                            step.classList.remove('active');
                            step.classList.add('completed');
                            step.innerHTML = `<i class="fas fa-check text-success me-2"></i>${message}`;
                            resolve();
                        }, delay);
                    } else {
                        resolve();
                    }
                }, 100);
            });
        }

        // 去重处理逻辑（优化版本）
        function processDeduplication(allData, checkedData, threshold, algorithm) {
            console.log('开始去重处理，数据量:', allData.length, checkedData.length);
            
            const getQuestionText = (row) => {
                const questionKey = Object.keys(row).find(key => key.includes('问题')) || '问题';
                return (row[questionKey] || '').toString().trim();
            };

            const getDepartmentText = (row) => {
                const deptKey = Object.keys(row).find(key => key.includes('部门')) || '对应部门';
                return (row[deptKey] || '').toString().trim();
            };

            // 处理全量数据
            const allQuestions = allData.map(row => ({
                original: row,
                question: getQuestionText(row),
                department: getDepartmentText(row)
            })).filter(item => item.question.length > 0);

            console.log('有效问题数量:', allQuestions.length);

            // 处理已复核数据，创建Set用于快速查找
            const checkedQuestions = new Set(
                checkedData.map(row => getQuestionText(row))
                    .filter(q => q.length > 0)
            );

            console.log('已复核问题数量:', checkedQuestions.size);

            // 排除无效部门
            const excludeDepts = new Set(['无效问题', '描述不清晰', '外部问题']);
            const validQuestions = allQuestions.filter(item => 
                !excludeDepts.has(item.department)
            );

            console.log('排除无效部门后:', validQuestions.length);

            let exactDuplicates = 0;
            let similarDuplicates = 0;
            const uncheckedQuestions = [];

            // 精确匹配和相似度匹配
            for (let i = 0; i < validQuestions.length; i++) {
                const item = validQuestions[i];
                
                // 每1000条输出进度
                if (i % 1000 === 0) {
                    console.log(`处理进度: ${i}/${validQuestions.length}`);
                }
                
                // 先检查精确匹配
                if (checkedQuestions.has(item.question)) {
                    exactDuplicates++;
                    continue;
                }

                // 相似度匹配（只对未精确匹配的进行）
                let maxSimilarity = 0;
                let bestMatch = '';
                let isSimilarDuplicate = false;

                // 限制相似度比较的数量，避免性能问题
                const checkedArray = Array.from(checkedQuestions);
                const maxComparisons = Math.min(checkedArray.length, 1000); // 最多比较1000条
                
                for (let j = 0; j < maxComparisons; j++) {
                    const checkedQ = checkedArray[j];
                    const similarity = calculateSimilarity(item.question, checkedQ, algorithm);
                    
                    if (similarity > maxSimilarity) {
                        maxSimilarity = similarity;
                        bestMatch = checkedQ;
                    }

                    if (similarity >= threshold) {
                        isSimilarDuplicate = true;
                        similarDuplicates++;
                        break;
                    }
                }

                if (!isSimilarDuplicate) {
                    const result = { ...item.original };
                    result['最大相似度'] = maxSimilarity.toFixed(3);
                    result['最相似已复核问题'] = bestMatch;
                    result['相似度算法'] = algorithm;
                    uncheckedQuestions.push(result);
                }
            }

            console.log('处理完成，结果:', {
                exactDuplicates,
                similarDuplicates,
                uncheckedQuestions: uncheckedQuestions.length
            });

            processedData = uncheckedQuestions;

            return {
                type: 'deduplication',
                algorithm: algorithm,
                threshold: threshold,
                statistics: {
                    totalQuestions: allQuestions.length,
                    validQuestions: validQuestions.length,
                    checkedQuestions: checkedQuestions.size,
                    exactDuplicates: exactDuplicates,
                    similarDuplicates: similarDuplicates,
                    uncheckedQuestions: uncheckedQuestions.length
                },
                message: `去重完成！使用${algorithm}算法，阈值${threshold}，找到${uncheckedQuestions.length}条未复核问题`
            };
        }

        // 分层抽样处理逻辑
        function processStratifiedSampling(data, sampleSize, threshold, departmentCol) {
            // 查找部门列
            const deptKey = Object.keys(data[0]).find(key => 
                key.includes(departmentCol) || key.includes('部门')
            ) || departmentCol;

            if (!data.some(row => row[deptKey])) {
                throw new Error(`未找到部门列: ${departmentCol}`);
            }

            // 按部门分组
            const deptGroups = {};
            data.forEach(row => {
                const dept = (row[deptKey] || '未知部门').toString().trim();
                if (!deptGroups[dept]) {
                    deptGroups[dept] = [];
                }
                deptGroups[dept].push(row);
            });

            const deptCounts = Object.keys(deptGroups).map(dept => ({
                name: dept,
                count: deptGroups[dept].length,
                data: deptGroups[dept]
            }));

            // 分离小部门和大部门
            const smallDepts = deptCounts.filter(d => d.count <= threshold);
            const largeDepts = deptCounts.filter(d => d.count > threshold);

            // 小部门全抽
            let sampledData = [];
            smallDepts.forEach(dept => {
                sampledData = sampledData.concat(dept.data);
            });

            // 大部门按比例抽样
            const remainingQuota = Math.max(0, sampleSize - sampledData.length);
            const totalLargeDeptCount = largeDepts.reduce((sum, d) => sum + d.count, 0);

            if (remainingQuota > 0 && totalLargeDeptCount > 0) {
                largeDepts.forEach(dept => {
                    const proportion = dept.count / totalLargeDeptCount;
                    const deptSampleSize = Math.min(
                        Math.round(remainingQuota * proportion),
                        dept.count
                    );
                    
                    // 随机抽样
                    const shuffled = dept.data.sort(() => 0.5 - Math.random());
                    sampledData = sampledData.concat(shuffled.slice(0, deptSampleSize));
                });
            }

            // 如果还没达到目标，从大部门补充
            if (sampledData.length < sampleSize && largeDepts.length > 0) {
                const remaining = sampleSize - sampledData.length;
                const allLargeData = largeDepts.flatMap(d => d.data)
                    .filter(row => !sampledData.includes(row));
                const shuffled = allLargeData.sort(() => 0.5 - Math.random());
                sampledData = sampledData.concat(shuffled.slice(0, remaining));
            }

            processedData = sampledData;

            return {
                type: 'sampling',
                sampleSize: sampleSize,
                threshold: threshold,
                statistics: {
                    totalData: data.length,
                    departmentCount: deptCounts.length,
                    smallDepartments: smallDepts.length,
                    largeDepartments: largeDepts.length,
                    smallDeptData: smallDepts.reduce((sum, d) => sum + d.count, 0),
                    largeDeptData: largeDepts.reduce((sum, d) => sum + d.count, 0),
                    finalSample: sampledData.length
                },
                departmentDetails: deptCounts.map(d => ({
                    name: d.name,
                    originalCount: d.count,
                    sampledCount: sampledData.filter(row => (row[deptKey] || '').toString().trim() === d.name).length,
                    isSmallDept: d.count <= threshold
                })),
                message: `抽样完成！从${data.length}条数据中抽取了${sampledData.length}条样本`
            };
        }

        // 显示结果
        function showResult(result) {
            const resultSection = document.querySelector('.result-section');
            const resultContent = document.getElementById('resultContent');
            const downloadBtn = document.getElementById('downloadBtn');
            const newProcessBtn = document.getElementById('newProcessBtn');
            
            let html = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>${result.message}</h5>
                </div>
            `;

            if (result.type === 'deduplication') {
                const stats = result.statistics;
                html += `
                    <div class="row">
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">总问题数</h6>
                                    <h4 class="text-primary">${stats.totalQuestions.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">有效问题</h6>
                                    <h4 class="text-info">${stats.validQuestions.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">已复核</h6>
                                    <h4 class="text-warning">${stats.checkedQuestions.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">精确重复</h6>
                                    <h4 class="text-danger">${stats.exactDuplicates.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">相似重复</h6>
                                    <h4 class="text-secondary">${stats.similarDuplicates.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-2 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h6 class="card-title">未复核</h6>
                                    <h4>${stats.uncheckedQuestions.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>算法信息：</strong> ${result.algorithm} 相似度算法，阈值 ${result.threshold}
                    </div>
                `;
            } else if (result.type === 'sampling') {
                const stats = result.statistics;
                html += `
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">总数据量</h6>
                                    <h4 class="text-primary">${stats.totalData.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">部门数量</h6>
                                    <h4 class="text-info">${stats.departmentCount}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">小部门</h6>
                                    <h4 class="text-warning">${stats.smallDepartments}个</h4>
                                    <small>${stats.smallDeptData}条数据</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h6 class="card-title">最终样本</h6>
                                    <h4>${stats.finalSample.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 部门详情
                if (result.departmentDetails && result.departmentDetails.length > 0) {
                    html += `
                        <div class="mt-3">
                            <h6>部门抽样详情：</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>部门名称</th>
                                            <th>原始数据</th>
                                            <th>抽样数据</th>
                                            <th>抽样比例</th>
                                            <th>类型</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    result.departmentDetails.forEach(dept => {
                        const ratio = dept.originalCount > 0 ? (dept.sampledCount / dept.originalCount * 100).toFixed(1) : '0';
                        html += `
                            <tr>
                                <td>${dept.name}</td>
                                <td>${dept.originalCount}</td>
                                <td>${dept.sampledCount}</td>
                                <td>${ratio}%</td>
                                <td>
                                    <span class="badge ${dept.isSmallDept ? 'bg-warning' : 'bg-info'}">
                                        ${dept.isSmallDept ? '小部门(全抽)' : '大部门(比例)'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
            
            resultContent.innerHTML = html;
            resultSection.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            newProcessBtn.style.display = 'inline-block';
            
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // 下载功能
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!processedData || processedData.length === 0) {
                alert('没有可下载的数据');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(processedData);
            
            // 设置列宽
            if (processedData.length > 0) {
                const colWidths = Object.keys(processedData[0]).map(key => ({
                    wch: Math.max(key.length, 15)
                }));
                ws['!cols'] = colWidths;
            }
            
            const sheetName = currentProcessType === 'deduplication' ? '未复核问题' : '抽样结果';
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
            const filename = currentProcessType === 'deduplication' 
                ? `海底捞_未复核问题_${timestamp}.xlsx`
                : `海底捞_分层抽样_${timestamp}.xlsx`;
            
            try {
                XLSX.writeFile(wb, filename);
                
                // 显示成功提示
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check me-2"></i>下载成功！';
                this.className = 'btn btn-success me-2';
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.className = 'btn btn-primary me-2';
                }, 2000);
                
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败，请重试');
            }
        });

        // 拖拽上传功能
        function setupDragAndDrop() {
            const uploadAreas = document.querySelectorAll('.upload-area');
            
            uploadAreas.forEach(area => {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    area.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    area.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    area.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    area.classList.add('dragover');
                }

                function unhighlight() {
                    area.classList.remove('dragover');
                }

                area.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    const input = area.parentElement.querySelector('input[type="file"]');
                    if (input && files.length > 0) {
                        input.files = files;
                        input.dispatchEvent(new Event('change'));
                    }
                }
            });
        }
    </script>
</body>
</html>
